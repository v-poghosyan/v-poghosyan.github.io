<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vahram Poghosyan">
<meta name="dcterms.date" content="2024-12-26">

<title>Three.js - 3D Animations in the Browser – v-poghosyan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../favicon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KLCX05QFPN"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-KLCX05QFPN', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="./css/three-js-demo.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../assets/site/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">v-poghosyan</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">Info</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">Three.js - 3D Animations in the Browser</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Three.js</div>
                <div class="quarto-category">Visualization</div>
                <div class="quarto-category">JavaScript</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Vahram Poghosyan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 26, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#three.js-webgl-and-the-canvas-element" id="toc-three.js-webgl-and-the-canvas-element" class="nav-link" data-scroll-target="#three.js-webgl-and-the-canvas-element">Three.js, WebGL, and the Canvas Element</a></li>
  <li><a href="#d-scenes---a-primer" id="toc-d-scenes---a-primer" class="nav-link" data-scroll-target="#d-scenes---a-primer">3D Scenes - A Primer</a>
  <ul>
  <li><a href="#meshes-objects-geometries-and-materials" id="toc-meshes-objects-geometries-and-materials" class="nav-link" data-scroll-target="#meshes-objects-geometries-and-materials">Meshes, Objects, Geometries, and Materials</a></li>
  </ul></li>
  <li><a href="#our-first-scene" id="toc-our-first-scene" class="nav-link" data-scroll-target="#our-first-scene">Our First Scene</a>
  <ul>
  <li><a href="#creating-a-scene" id="toc-creating-a-scene" class="nav-link" data-scroll-target="#creating-a-scene">Creating a Scene</a></li>
  <li><a href="#defining-scene-properties-and-selecting-a-canvas" id="toc-defining-scene-properties-and-selecting-a-canvas" class="nav-link" data-scroll-target="#defining-scene-properties-and-selecting-a-canvas">Defining Scene Properties and Selecting a Canvas</a></li>
  <li><a href="#creating-a-camera" id="toc-creating-a-camera" class="nav-link" data-scroll-target="#creating-a-camera">Creating a Camera</a></li>
  <li><a href="#creating-a-webgl-renderer" id="toc-creating-a-webgl-renderer" class="nav-link" data-scroll-target="#creating-a-webgl-renderer">Creating a WebGL Renderer</a>
  <ul class="collapse">
  <li><a href="#how-does-a-renderer-work" id="toc-how-does-a-renderer-work" class="nav-link" data-scroll-target="#how-does-a-renderer-work">How Does a Renderer Work?</a></li>
  </ul></li>
  <li><a href="#rendering-the-scene-and-adding-objects" id="toc-rendering-the-scene-and-adding-objects" class="nav-link" data-scroll-target="#rendering-the-scene-and-adding-objects">Rendering the Scene and Adding Objects</a></li>
  <li><a href="#adding-simple-animations" id="toc-adding-simple-animations" class="nav-link" data-scroll-target="#adding-simple-animations">Adding Simple Animations</a></li>
  <li><a href="#optional-displaying-multiple-scenes" id="toc-optional-displaying-multiple-scenes" class="nav-link" data-scroll-target="#optional-displaying-multiple-scenes">(Optional) Displaying Multiple Scenes</a></li>
  <li><a href="#loading-custom-objects-with-materials" id="toc-loading-custom-objects-with-materials" class="nav-link" data-scroll-target="#loading-custom-objects-with-materials">Loading Custom Objects with Materials</a>
  <ul class="collapse">
  <li><a href="#creating-a-skybox" id="toc-creating-a-skybox" class="nav-link" data-scroll-target="#creating-a-skybox">Creating a Skybox</a></li>
  <li><a href="#loading-the-object" id="toc-loading-the-object" class="nav-link" data-scroll-target="#loading-the-object">Loading the Object<br>
  </a></li>
  </ul></li>
  <li><a href="#adding-simple-camera-controls" id="toc-adding-simple-camera-controls" class="nav-link" data-scroll-target="#adding-simple-camera-controls">Adding Simple Camera Controls</a></li>
  </ul></li>
  <li><a href="#creating-more-complex-scenes" id="toc-creating-more-complex-scenes" class="nav-link" data-scroll-target="#creating-more-complex-scenes">Creating More Complex Scenes</a>
  <ul>
  <li><a href="#representation-of-an-object" id="toc-representation-of-an-object" class="nav-link" data-scroll-target="#representation-of-an-object">Representation of an Object</a></li>
  <li><a href="#homogeneous-coordinates" id="toc-homogeneous-coordinates" class="nav-link" data-scroll-target="#homogeneous-coordinates">Homogeneous Coordinates</a></li>
  <li><a href="#the-coordinate-system" id="toc-the-coordinate-system" class="nav-link" data-scroll-target="#the-coordinate-system">The Coordinate System</a></li>
  <li><a href="#adding-multiple-of-the-same-object-to-a-scene-efficiently" id="toc-adding-multiple-of-the-same-object-to-a-scene-efficiently" class="nav-link" data-scroll-target="#adding-multiple-of-the-same-object-to-a-scene-efficiently">Adding Multiple of the Same Object to a Scene (Efficiently)</a>
  <ul class="collapse">
  <li><a href="#instanced-mesh" id="toc-instanced-mesh" class="nav-link" data-scroll-target="#instanced-mesh">Instanced Mesh</a></li>
  </ul></li>
  <li><a href="#adding-physics" id="toc-adding-physics" class="nav-link" data-scroll-target="#adding-physics">Adding Physics</a></li>
  <li><a href="#shaders" id="toc-shaders" class="nav-link" data-scroll-target="#shaders">Shaders</a>
  <ul class="collapse">
  <li><a href="#how-to-use-shaders-from-three.js" id="toc-how-to-use-shaders-from-three.js" class="nav-link" data-scroll-target="#how-to-use-shaders-from-three.js">How to Use Shaders from Three.js</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this post we use <a href="https://threejs.org/">Three.js</a> external scripts to render 3D scenes inside this Jupyter notebook.</p>
<p>This post will be very similar, in terms of its stack, to the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US map post</a>.</p>
<p>In <em>that</em> post, we learned that Canvas and SVG are two ways in which we can display complex graphics inside a web browser. We already explored SVG graphics in <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US map</a>. It’s worth noting that a lot of the same functionality could’ve been replicated using the HTML Canvas element instead of SVG (which we ultimately chose for its superior interactive capabilities) – the article mentions one way to do that by using <a href="https://github.com/samizdatco/skia-canvas">skia-canvas</a>.</p>
<p>We ended up using <a href="https://github.com/WebReflection/linkedom#readme">linkedom</a> to add a DOM API on top of the Deno environment.</p>
<p>In fact, what I realized later on is that we could’ve simply used the Markdown inside our Jupyter notebook to create the <code>&lt;svg&gt;</code> element without the need to introduce a third-party DOM API on top of a browser-less JavaScript environment (Deno). Then, we could have simply fetched the <code>TopoJSON</code> data and constructed the map inside our external scripts with the rest of the complex D3 animations that had to be added as external scripts. These scripts are run by Quarto only <em>after</em> the page has been rendered to the browser, so we can easily reference the DOM elements we create inside our notes by <code>class</code> or <code>id</code>. Crucially, the external scripts are meant to run <em>inside the browser</em> (as opposed to being pre-computed in the browser-less Deno environment). Inside the browser they’re able to leverage the existing DOM API provided by the browser’s engine (e.g.&nbsp;<code>document.getElementById</code>). Hence, this way, we eliminate the need for Deno as well as Linkedom.</p>
<p>We will use the <a href="https://ipython.readthedocs.io/en/8.26.0/api/generated/IPython.display.html">IPython.display</a> module to create HTML elements inside our notes rather than just using Markdown directly.</p>
</section>
<section id="three.js-webgl-and-the-canvas-element" class="level1">
<h1>Three.js, WebGL, and the Canvas Element</h1>
<p><a href="https://threejs.org/">Three.js</a> is a library for drawing 3D graphics in the browser using JavaScript and <a href="https://get.webgl.org/">WebGL</a> (see <a href="https://www.khronos.org/webgl/wiki/Main_Page">wiki</a>). One excellent resource for learning WebGL is the <a href="https://webglfundamentals.org/webgl/lessons">WebGLFundamentals</a> website.</p>
<p>WebGL runs in an HTML Canvas (i.e.&nbsp;<code>&lt;canvas&gt;</code>).</p>
<p>From the WebGL wiki:</p>
<blockquote class="blockquote">
<p>WebGL is a DOM API, which means that it can be used in any DOM-compatible language: e.g.&nbsp;JavaScript</p>
</blockquote>
<p>Three.js is a library that provides conveniences in JavaScript that abstract much of this <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API">WebGL</a> DOM API calls behind friendlier JavaScript code.</p>
<p>Note that WebGL and Canvas API are two distinct ways in which the browser draws graphics, but they both require and HTML Canvas to draw on. Three.js offers a WebGL renderer as well as a Canvas renderer. Canvas API is usually a fallback option for when WebGL, the more powerful of the two APIs, isn’t available.</p>
<p>Note, also, that Three.js isn’t suitable for modelling purposes, for that we can use <a href="https://www.blender.org/">Blender</a> or a number of other closed-source 3D modelling applications. We can even download or purchase third-party models from vendors.</p>
<p>Canvas and SVG elements are two ways in which we can display complex graphics inside a web browser. We already explored SVG graphics in the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US Map</a> post. It’s worth noting that a lot of the same functionality could’ve been achieved by using the HTML Canvas element with D3.js instead. The post above mentions one way to do that by using <a href="https://github.com/samizdatco/skia-canvas">skia-canvas</a>.</p>
<p>However, in this post, we use Three.js (not D3.js), to draw inside an HTML Canvas element (rather than an HTML SVG element) using WebGL (as opposed to the Canvas API).</p>
</section>
<section id="d-scenes---a-primer" class="level1">
<h1>3D Scenes - A Primer</h1>
<p>In <em>any</em> 3D scene, be it in the web browser, inside a game engine, in a movie, in a 3D modelling application, etc. there are a bunch of <strong>geometries</strong>, or <strong>shapes</strong> that are packaged with <strong>materials</strong> as <strong>meshes</strong>. The materials can describe simple properties like reflectivity, opacity, refraction index, etc. or they can be <strong>textures</strong> which are just simple <a href="https://en.wikipedia.org/wiki/Raster_graphics">raster</a> images. We can also apply <strong>shaders</strong> to our objects, which are complex mappings of pixels (or vertices) that make up an interesting animation.</p>
<p>A scene will also have one or more <strong>light sources</strong>, and a <strong>camera</strong> to <em>serve</em> the scene in some perspective.</p>
<section id="meshes-objects-geometries-and-materials" class="level2">
<h2 class="anchored" data-anchor-id="meshes-objects-geometries-and-materials">Meshes, Objects, Geometries, and Materials</h2>
<p>An <code>object</code>, for the foreseeable future, means an object file of the <a href="https://en.wikipedia.org/wiki/Wavefront_.obj_file">OBJ Wavefront format</a>. These are files that consist of <code>object.children[n].geometry</code> and <code>object.children[n].material</code> fields. However, the material fields inside an OBJ are just <em>references</em> (via <code>usemtl</code> statements) to the true materials which come separately in <code>.mtl</code> files (typically from the same place as the <code>.obj</code> file).</p>
<p>There’s usually no need to break the object down into individual child geometries and their corresponding objects. But, it’s certainly possible. One use case would be if we want to apply a different transformation to each component. Usually, however, we load the object as a whole.</p>
</section>
</section>
<section id="our-first-scene" class="level1">
<h1>Our First Scene</h1>
<p>Let’s create a <code>&lt;canvas&gt;</code> with <code>id="three-d-canvas"</code>.</p>
<p>We can do it either using raw markup below this very cell, or by using the <code>IPython.display</code> module which allows us to display rich representations of objects in a Jupyter notebook (much like the <code>Deno.jupyter.display</code> module we saw in the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js US map post</a>).</p>
<p>Using <code>IPython.display</code> is more reliable.</p>
<div id="cell-2" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas"></canvas>
</div>
</div>
<p>Here’s the code that produces the above output. Feel free to expand and examine. We will paint the general strokes below.</p>
<details>
<summary>
Click to expand the Torus code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/+esm'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">setZ</span>(<span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canvas</span><span class="op">:</span> canvas</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>( <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> )<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>( bodyWidth<span class="op">,</span> bodyHeight )<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> geometry <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">TorusGeometry</span>(<span class="dv">10</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> material <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshBasicMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0xFF6347</span><span class="op">,</span> <span class="dt">wireframe</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> torus <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(geometry<span class="op">,</span> material)<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(torus)<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.005</span><span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="fu">animate</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>You’ll notice some general strokes.</p>
<section id="creating-a-scene" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-scene">Creating a Scene</h2>
<p>First, we create a <code>three.Scene</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="defining-scene-properties-and-selecting-a-canvas" class="level2">
<h2 class="anchored" data-anchor-id="defining-scene-properties-and-selecting-a-canvas">Defining Scene Properties and Selecting a Canvas</h2>
<p>Then, we define some constants for Three.js’s <a href="https://threejs.org/docs/#api/en/renderers/WebGLRenderer">WebGLRenderer</a> relative to the HTML document’s body (grabbing the latter using the DOM API).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We then grab the <code>&lt;canvas&gt;</code> element we created.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-a-camera" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-camera">Creating a Camera</h2>
<p>After defining scene properties, we create a <a href="https://threejs.org/docs/#api/en/cameras/PerspectiveCamera">PerspectiveCamera</a>, supplying it the <a href="https://en.wikipedia.org/wiki/Field_of_view">field of view</a> among other attributes, and setting its position.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">setZ</span>(<span class="dv">30</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-a-webgl-renderer" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-webgl-renderer">Creating a WebGL Renderer</h2>
<p>We then create the <code>WebGLRenderer</code> object, supplying it the <code>canvas</code> to render, as well as setting some of its parameters to the constants we defined in step one.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canvas</span><span class="op">:</span> canvas</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>( <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> )<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>( bodyWidth<span class="op">,</span> bodyHeight )<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="how-does-a-renderer-work" class="level3">
<h3 class="anchored" data-anchor-id="how-does-a-renderer-work">How Does a Renderer Work?</h3>
<p>A renderer such as WebGL uses <a href="https://en.wikipedia.org/wiki/Ray_marching">ray-marching</a> and <a href="https://en.wikipedia.org/wiki/Signed_distance_function">signed distance functions</a> (SDFs) to render a scene.</p>
<p>At a very high level, there’s a plane that represents what the camera sees. This is what’s displayed on our 2D screens, the plane maps to pixels on our screen. A “ray” is cast through each pixel and the ray marching algorithm determines which object in our 3D scene the ray intersects with first. This will determine which object is on the foreground and which in the background (the pixel will be colored according to this determination).</p>
<p>Each point on the ray has a known coordinate in 3D space. Each object in our 3D scene also has a known position in the coordinate system (i.e.&nbsp;all of its vertices/edges are not unknowns). For each object, the distance between a point <span class="math inline">\(p\)</span> on the ray and the boundary of the object is calculated using a <em>signed distance function</em> (as mentioned before). These functions depend on the geometry. They are known for some primitive geometries (and their unions/intersections). A comprehensive list of SDFs is available <a href="https://iquilezles.org/articles/distfunctions/">here</a>.</p>
<p>The point <span class="math inline">\(p\)</span> on the ray is marched only as far as the distance between the previous <span class="math inline">\(p\)</span> iterate (say <span class="math inline">\(p^-\)</span>) and the closest object to it in the 3D scene (call this object <span class="math inline">\(A\)</span>). This guarantees that there are no collisions with any of the <em>other</em> objects for point <span class="math inline">\(p\)</span> moving on the ray. So, <span class="math inline">\(p\)</span> is marched that far. Then, <span class="math inline">\(p\)</span> is updated again in the same way, iteratively. Eventually point <span class="math inline">\(p\)</span> touches an object (the object that intersects with the ray <em>first</em>) – in the limit. In practice, we can stop after some <span class="math inline">\(K\)</span> iterations or when the distance <span class="math inline">\(d(p, A)\)</span> – where <span class="math inline">\(A\)</span> is the nearest object – is sufficiently small (i.e.&nbsp;less than some <span class="math inline">\(\Epsilon\)</span>).</p>
<p>If the ray misses, the corresponding pixel is rendered as background (for example, the color the sky). In contrast, the objects the ray hits are colored according to their distance from the pixel on the screen (according to a greyscale, for example).</p>
<p>In this article we just focus on the high-level implementations in Three.js, so all of this is abstracted behind WebGL and further abstracted behind Three.js. However, in the future it may be nice to program a rudimentary renderer from scratch…</p>
</section>
</section>
<section id="rendering-the-scene-and-adding-objects" class="level2">
<h2 class="anchored" data-anchor-id="rendering-the-scene-and-adding-objects">Rendering the Scene and Adding Objects</h2>
<p>Finally, we render the scene by invoking the renderer’s <code>.render(scene, camera)</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>scene</code> object continues to be our window into the 3D world we just created. To it, we add <code>geometries</code> and their <code>materials</code> through a combination object called a <a href="https://threejs.org/docs/#api/en/objects/Mesh">Mesh</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> geometry <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">TorusGeometry</span>(<span class="dv">10</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> material <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshBasicMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0xFF6347</span><span class="op">,</span> <span class="dt">wireframe</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> torus <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(geometry<span class="op">,</span> material)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(torus)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adding-simple-animations" class="level2">
<h2 class="anchored" data-anchor-id="adding-simple-animations">Adding Simple Animations</h2>
<p>We can also add a little life to the scene by using a custom animation function.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.005</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We invoke the animation within the outer lexical environment (for now).</p>
<pre><code>animate();</code></pre>
</section>
<section id="optional-displaying-multiple-scenes" class="level2">
<h2 class="anchored" data-anchor-id="optional-displaying-multiple-scenes">(Optional) Displaying Multiple Scenes</h2>
<p>To display multiple 3D <code>scenes</code> in a grid, we can simply use a CSS-grid inside Jupyter.</p>
<p>First we lay out the markup inside the notes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-container"</span><span class="dt">&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-1"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-2"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-3"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-4"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, we include the stylesheet in this post’s subdirectory, and use Quarto’s front-matter to load it into the browser (just as we load the external scripts used to produce these rich 3D outputs):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">include-after-body</span><span class="kw">:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;script type="module" src="./javascript/three-js-demo.js"&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It turns out that there’s support for including CSS inside a Quarto post. It’s done using the <code>format.html</code> flag in the front-matter as follows:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">css</span><span class="kw">:</span><span class="at"> ./css/three-js-demo.css</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The file <code>three-js-demo.css</code> should contain these minimal styles:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#three-d-grid-container</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">grid-template-columns</span><span class="ch">:</span> <span class="fu">repeat(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="dt">fr</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">grid-template-rows</span><span class="ch">:</span> <span class="fu">repeat(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="dt">fr</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">gap</span><span class="ch">:</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">height</span><span class="ch">:</span> <span class="dv">50</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.three-d-grid-item</span> {</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s add the grid markup.</p>
<p>Now, inside the external script, we can reference the various <code>canvas</code> elements by <code>id</code>.</p>
<div id="cell-7" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>display(HTML(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div id='three-d-grid-container'&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-1"&gt;&lt;canvas id="three-d-canvas-1"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-2"&gt;&lt;canvas id="three-d-canvas-2"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-3"&gt;&lt;canvas id="three-d-canvas-3"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-4"&gt;&lt;canvas id="three-d-canvas-4"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

    <div id="three-d-grid-container">
        <div class="three-d-grid-item" id="three-d-grid-item-1"><canvas id="three-d-canvas-1"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-2"><canvas id="three-d-canvas-2"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-3"><canvas id="three-d-canvas-3"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-4"><canvas id="three-d-canvas-4"></canvas></div>
    </div>
    
</div>
</div>
</section>
<section id="loading-custom-objects-with-materials" class="level2">
<h2 class="anchored" data-anchor-id="loading-custom-objects-with-materials">Loading Custom Objects with Materials</h2>
<p>Quarto won’t serve <code>.obj</code> files (at least by default), so we can just commit the object file to the remote repository and use the <code>raw</code> GitHub link (as a CDN).</p>
<p>We will also need the <code>OBJLoader</code>, a Three.js add-on. This can be grabbed from a CDN as well. We may also include it in the <code>include-after-body.text</code> front matter <em>before</em> loading the script file itself as:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;script type="importmap"&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">"imports"</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"three"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/+esm"</span><span class="kw">,</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"OBJLoader"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then, within the script, import as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'three'</span><span class="op">;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'OBJLoader'</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s the full code to render a rubber ducky which will help us in debugging our code going forward! I downloaded this model from <a href="https://sketchfab.com/3d-models/rubber-duck-ecb9ce9ff973406398ee56e391f9c902">Sketchfab</a> which hosts many such free models.</p>
<section id="creating-a-skybox" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-skybox">Creating a Skybox</h3>
<p>We can also create a sky background (using what’s known as a <em>skybox</em>). This can be done in several ways, the most unsophisticated of which is to add a simple gradient background.</p>
<p>Going one step further, we can add a skybox (a <a href="https://threejs.org/docs/#api/en/loaders/CubeTextureLoader">cubemap</a>).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loader <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeTextureLoader</span>()<span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> skyboxTexture <span class="op">=</span> loader<span class="op">.</span><span class="fu">load</span>([</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'px.jpg'</span><span class="op">,</span> <span class="co">// Right</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'nx.jpg'</span><span class="op">,</span> <span class="co">// Left</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'py.jpg'</span><span class="op">,</span> <span class="co">// Top</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'ny.jpg'</span><span class="op">,</span> <span class="co">// Bottom</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">'pz.jpg'</span><span class="op">,</span> <span class="co">// Front</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">'nz.jpg'</span>  <span class="co">// Back</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Set the scene's background to `skyboxTexture`</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="at">background</span> <span class="op">=</span> skyboxTexture<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s a <a href="https://jaxry.github.io/panorama-to-cubemap/">convenient tool</a> that lets us convert a 360<span class="math inline">\(^{\circ}\)</span> image of a sky into a cubemap. We can also download existing cubemaps from the internet. One place to get them is <a href="https://polyhaven.com/a/lilienstein">Poly Haven’s HDRI section</a>. We can download any sky HDRs and use <a href="https://matheowis.github.io/HDRI-to-CubeMap/">this awesome tool</a> which converts the HDR file into six separate textures which can be supplied to the <code>loader.load()</code> call above.</p>
<p>Then, <a href="https://threejs.org/docs/#api/en/cameras/CubeCamera">CubeCamera</a> is used to render the skybox images. This camera exists independently of the main camera in our scene. The <code>CubeCamera</code> uses what’s known as a <a href="https://webglfundamentals.org/webgl/lessons/webgl-render-to-texture.html">render target</a> (a buffer where the GPU draws pixels for a scene that is being rendered in the background). Our <code>CubeCamera</code> will use <a href="https://threejs.org/docs/index.html#api/en/renderers/WebGLRenderTarget">WebGLCubeRenderTarget</a> to render the skybox images.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create the CubeRenderTarget and CubeCamera</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeRenderTarget <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLCubeRenderTarget</span>(<span class="dv">512</span>)<span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeCamera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeCamera</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> cubeRenderTarget)<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Add CubeCamera to the scene</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(cubeCamera)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also have the option to use the <code>Sky</code> class that’s built into Three.js to generate a procedural sky. The <code>Sky</code> class is a separate import accessible at the CDN address:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/objects/Sky.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, this is beyond the scope of this post.</p>
</section>
<section id="loading-the-object" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-object">Loading the Object<br>
</h3>
<p>Here’s the final code snippet that produces the scene below.</p>
<details>
<summary>
Click to expand the code used to generate the rubber ducky
</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/build/three.module.js'</span><span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js'</span><span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MTLLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js'</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the container and set dimensions</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Set up the canvas, scene, camera, and renderer</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({ <span class="dt">canvas</span><span class="op">:</span> canvas })<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>(<span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span>)<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>(bodyWidth<span class="op">,</span> bodyHeight)<span class="op">;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Position the camera so the object will be in view.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Add some lights so the materials are visible.</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ambientLight <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">AmbientLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.6</span>)<span class="op">;</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(ambientLight)<span class="op">;</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> directionalLight <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">DirectionalLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.8</span>)<span class="op">;</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>directionalLight<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(directionalLight)<span class="op">;</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a skybox</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loader <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeTextureLoader</span>()<span class="op">;</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> px <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/px.png'</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nx <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nx.png'</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> py <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/py.png'</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ny <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/ny.png'</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pz <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/pz.png'</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nz <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nz.png'</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> texture <span class="op">=</span> loader<span class="op">.</span><span class="fu">load</span>([</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  px<span class="op">,</span> <span class="co">// Right</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  nx<span class="op">,</span> <span class="co">// Left</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  py<span class="op">,</span> <span class="co">// Top</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  ny<span class="op">,</span> <span class="co">// Bottom</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  pz<span class="op">,</span> <span class="co">// Front</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  nz  <span class="co">// Back</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Set the scene's background to `texture`</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="at">background</span> <span class="op">=</span> texture<span class="op">;</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Create the CubeRenderTarget</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeRenderTarget <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLCubeRenderTarget</span>(<span class="dv">512</span>)<span class="op">;</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeCamera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeCamera</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> cubeRenderTarget)<span class="op">;</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(cubeCamera)<span class="op">;</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="co">// Instantiate MTLLoader and define the URLs for the material and object.</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mtlLoader <span class="op">=</span> <span class="kw">new</span> <span class="fu">MTLLoader</span>()<span class="op">;</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckMtl <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.mtl"</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckObj <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.obj"</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the MTL file first.</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>mtlLoader<span class="op">.</span><span class="fu">load</span>(</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  duckMtl<span class="op">,</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  (materials) <span class="kw">=&gt;</span> {</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    materials<span class="op">.</span><span class="fu">preload</span>()<span class="op">;</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Now load the OBJ file and set its materials.</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> objLoader <span class="op">=</span> <span class="kw">new</span> <span class="fu">OBJLoader</span>()<span class="op">;</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>    objLoader<span class="op">.</span><span class="fu">setMaterials</span>(materials)<span class="op">;</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>    objLoader<span class="op">.</span><span class="fu">load</span>(</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>      duckObj<span class="op">,</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>      (object) <span class="kw">=&gt;</span> {</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scale and position the loaded object.</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>        object<span class="op">.</span><span class="at">scale</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">5</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>        object<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>        scene<span class="op">.</span><span class="fu">add</span>(object)<span class="op">;</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Animation loop</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>          object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>          renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">animate</span>()<span class="op">;</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>      <span class="co">// onProgress callback</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>      (xhr) <span class="kw">=&gt;</span> {</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Loading object..."</span>)<span class="op">;</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>      <span class="co">// onError callback</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>      (error) <span class="kw">=&gt;</span> {</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'An error occurred while loading the OBJ:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">// onProgress callback for MTL</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>  (xhr) <span class="kw">=&gt;</span> {</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Loading materials..."</span>)<span class="op">;</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">// onError callback for MTL</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>  (error) <span class="kw">=&gt;</span> {</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'An error occurred while loading the MTL:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Note that <code>OBJLoader</code> takes the URL of the object followed by a callback function that gets triggered by the object fully loading.</p>
<p>The geometries of the object are in <code>object.children[n].geometry</code>. Each child is a single part of the duck (for example its eyes, wings, and nose).</p>
<p>In addition to the material that comes with the object, we can also add our own materials on top of it using this syntax:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Set envMap for all materials</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>materials<span class="op">.</span><span class="at">materials</span> <span class="op">&amp;&amp;</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(materials<span class="op">.</span><span class="at">materials</span>)<span class="op">.</span><span class="fu">forEach</span>(material <span class="kw">=&gt;</span> {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  material<span class="op">.</span><span class="at">envMap</span> <span class="op">=</span> scene<span class="op">.</span><span class="at">background</span><span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  material<span class="op">.</span><span class="at">envMapIntensity</span> <span class="op">=</span> <span class="fl">0.3</span><span class="op">;</span>  <span class="co">// Lower value = less reflective (range 0-1)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  material<span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The above code should be called within the <code>mtlLoader.load</code> callback function, after the <code>materials</code> have been preloaded. This uses short-circuit evaluation (logical AND) to check if <code>materials.materials</code> is truthy (i.e.&nbsp;not <code>undefined</code> or <code>null</code>). If it is, we can safely call <code>Object.values(materials.materials)</code> to get the values of the materials, and then method-chain to set the <code>envMap</code> and <code>envMapIntensity</code> properties for each material.</p>
<p>Let’s create another canvas to render the rubber duck.</p>
<div id="cell-9" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-5'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-5"></canvas>
</div>
</div>
<p>For the materials, we used <code>MTLLoader</code>. Another add-on downloaded from the following CDN in the <code>include-after-body.text</code> front matter:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;script type="importmap"&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">{</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">"imports"</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"MTLLoader"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js"</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">}</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">}</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice the nested calls? <code>OBJLoader</code> is typically called within <code>MTLLoader</code>, and gets the <code>material</code> supplied to it.</p>
<p>The <code>MTLLoader</code> loads the material file (<code>rubber_duck.mtl</code>) and then calls <code>materials.preload()</code>. The <code>OBJLoader</code>’s <code>.setMaterials(materials)</code> ensures that when the OBJ file is loaded, it uses the material definitions from the MTL file.</p>
</section>
</section>
<section id="adding-simple-camera-controls" class="level2">
<h2 class="anchored" data-anchor-id="adding-simple-camera-controls">Adding Simple Camera Controls</h2>
<p>What good is rendering a skybox if we can’t zoom and pan around to experience it in 3D? <a href="https://threejs.org/docs/#examples/en/controls/OrbitControls">OrbitControls</a> allow us to do just that! Let’s add them to our scene.</p>
<p><code>OrbitControls</code> can be imported from the following CDN:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As with all Three.js add-ons so far, we import <code>OrbitControls</code> using Quarto’s front-matter.</p>
<p>Once it’s imported, we add <code>OrbitControls</code> to our scene.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add OrbitControls</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controls <span class="op">=</span> <span class="kw">new</span> <span class="fu">OrbitControls</span>(camera<span class="op">,</span> renderer<span class="op">.</span><span class="at">domElement</span>)<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">enableDamping</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// Smooth damping effect during rotation</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">dampingFactor</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line <code>const controls = new OrbitControls(camera, renderer.domElement)</code> passes <code>renderer.domElement</code> instead of just <code>renderer</code> because <code>OrbitControls</code> needs a DOM element to attach event listeners to (for mouse or touch interactions), not a renderer object. A Three.js rendering object manages the WebGL context, <code>renderer.domElement</code> is the actual HTML Canvas element to which Three.js renders the scene.</p>
<p>Furthermore, inside the <code>animate()</code> call, we need to ensure that we’re updating <code>CubeCamera</code>’s environment map. This is done to retain realistic reflections on shiny objects. Reflective objects show surrounding environment reflected on their surfaces, so the <code>CubeMap</code> needs to be updated whenever the scene changes in order to keep reflections on objects accurate.</p>
<p>The animate block, which previously looked like:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Becomes:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  cubeCamera<span class="op">.</span><span class="fu">update</span>(renderer<span class="op">,</span> scene)<span class="op">;</span>  </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  controls<span class="op">.</span><span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line <code>conrols.update()</code> is required the animation loop to ensure smooth interaction and rendering. Without this call, the camera might not respond to user input correctly.</p>
<p>Also, now that we have <code>OrbitControls</code>, let’s ensure we’re positioning the camera to show the duck at the start of our scene. This is done within the <code>OBJLoader</code> callback, where the <code>object</code> is defined.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">copy</span>(object<span class="op">.</span><span class="at">position</span>)<span class="op">;</span>  <span class="co">// Set camera at duck position</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="dv">20</span><span class="op">;</span>  <span class="co">// Add y-offset (adjust value as needed)</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="op">-</span><span class="dv">20</span>  <span class="co">// Add z-offset offset (adjust value as needed)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="fu">lookAt</span>(object<span class="op">.</span><span class="at">position</span>) <span class="co">// Orient the camera to look at the duck</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Go ahead and try the controls in the canvas above. Use:</p>
<ul>
<li>Right mouse button (RMB) to pan</li>
<li>Left mouse button (LMB) to rotate</li>
<li>Scroll wheel (SW) to zoom</li>
</ul>
<p>Before we move on to creating more complex scenes, with multiple objects, we should explore how an OBJ file represents an object. We will need to understand the structure of an Object to manipulate it correctly using Three.js.</p>
</section>
</section>
<section id="creating-more-complex-scenes" class="level1">
<h1>Creating More Complex Scenes</h1>
<p>The Canvas, by itself, is a thing of wonder (as in the HTML Canvas element used in conjunction with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">Canvas API</a>). Here’s a curated list of cool <a href="https://github.com/raphamorim/awesome-canvas?tab=readme-ov-file">Canvas API examples</a>. For example, here’s <a href="https://cssdeck.com/labs/full/ping-pong-game-tutorial-with-html5-canvas-and-sounds">Pong</a>. Here’s a cool <a href="https://matrix.dotglitch.dev/">Matrix animation</a>, and here’s a tool that visualizes <a href="https://www.kevs3d.co.uk/dev/lsystems/#">L-systems</a>. The Canvas is what makes things like drawing, vector art, and diagramming tools (such as <a href="https://www.lucidchart.comB">Lucidchart</a> or <a href="https://app.diagrams.net/">diagrams.net</a>) possible on the browser. Some of that burden is also, perhaps, shared by the <a href="https://developer.mozilla.org/en-US/docs/Web/API/SVG_API">SVG DOM API</a> used in conjunction with an SVG element.</p>
<p>For more complex scenes, the HTML Canvas used purely with Canvas API is not enough. The Canvas API is usually good for 2D applications, however. It often requires explicitly setting its <code>context</code> as 2D. This is where WebGL (which is abstracted for us behind Three.js) comes into play. WebGL is a more powerful DOM API than is Canvas API.</p>
<p>Furthermore, for truly complex 3D web-applications (complete with mouse and keyboard controls and other advanced features), we will need to integrate Three.js into a React app, perhaps, using <a href="https://r3f.docs.pmnd.rs/getting-started/introduction">React Three Fiber (r3f)</a>. React Three Fiber is a library that serves as a React renderer for Three.js. It enables the creation and management of 3D scenes and objects using React components, rather than plain HTML (allowing developers to leverage React’s component system as well as state/effect management through hooks like <code>useEffect</code>). React’s lifecycle methods, like <code>componentDidMount</code>, <code>componentDidUpdate</code>, and <code>componentWillUnmount</code>, help to further abstract the browser’s own DOM events (so that we don’t have to use something like <code>DOMContentLoaded</code> manually). In short, you get the benefits of React…</p>
<p>For now, however, we will not use React Three Fiber (we will use in a separate post on <a href="../../../unpublished_posts/visualization/react-three-fiber-with-theater/react-three-fiber-with-theater.html">React Three Fiber with Theater.js</a>). We will see how far we can take Three.js in Jupyter notebooks using Quarto, instead of React, to publish this page on the browser. Let’s make a more complex scene now, by adding more objects. Let’s add more rubber duckies to the scene! Once we are able to display more of the same object, we can perhaps explore some physics (like making it rain ducks).</p>
<section id="representation-of-an-object" class="level2">
<h2 class="anchored" data-anchor-id="representation-of-an-object">Representation of an Object</h2>
<p>When Three.js parses an <code>.obj</code> (an OBJ file supplied to it), it represents it as a <code>Group</code> which is a JSON representation of an object that looks much like the following one (as far as Three.js is concerned):</p>
<details>
<summary>
Click to expand json with comments
</summary>
<div class="sourceCode" id="cb31"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="er">Group</span> <span class="fu">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"children"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mesh"</span><span class="er">:</span> <span class="fu">{</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"geometry"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span> <span class="er">//</span> <span class="er">See</span> <span class="er">below</span> <span class="er">for</span> <span class="er">full</span> <span class="er">expansion...</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"material"</span><span class="er">:</span> <span class="st">"Material"</span> <span class="er">//</span> <span class="er">See</span> <span class="er">below</span> <span class="er">for</span> <span class="er">full</span> <span class="er">expansion...</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mesh"</span><span class="er">:</span> <span class="fu">{</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"geometry"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metadata"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Metadata</span> <span class="er">provides</span> <span class="er">info</span> <span class="er">about</span> <span class="er">the</span> <span class="er">export</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"version"</span><span class="fu">:</span> <span class="fl">4.5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Exporter</span> <span class="er">version</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Type</span> <span class="er">of</span> <span class="er">object</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"generator"</span><span class="fu">:</span> <span class="st">"BufferGeometry.toJSON"</span><span class="er">//</span> <span class="er">Method</span> <span class="er">that</span> <span class="er">generated</span> <span class="er">this</span> <span class="er">JSON</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"uuid"</span><span class="fu">:</span> <span class="st">"12345678-1234-1234-1234-123456789abc"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Unique</span> <span class="er">identifier</span> <span class="er">for</span> <span class="er">this</span> <span class="er">geometry</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Confirms</span> <span class="er">that</span> <span class="er">this</span> <span class="er">is</span> <span class="er">a</span> <span class="er">BufferGeometry</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Main</span> <span class="er">container</span> <span class="er">for</span> <span class="er">all</span> <span class="er">geometry</span> <span class="er">data</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"attributes"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Vertex</span> <span class="er">attributes</span> <span class="er">(data</span> <span class="er">arrays</span> <span class="er">for</span> <span class="er">each</span> <span class="er">vertex</span> <span class="er">property)</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"position"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Positions</span> <span class="er">of</span> <span class="er">vertices</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Each</span> <span class="er">vertex</span> <span class="er">position</span> <span class="er">has</span> <span class="er">3</span> <span class="er">components</span><span class="fu">:</span> <span class="er">x</span><span class="fu">,</span> <span class="er">y</span><span class="fu">,</span> <span class="er">z</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">stored</span> <span class="er">as</span> <span class="er">a</span> <span class="er">Float32Array</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">vertex</span> <span class="er">positions</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">is</span> <span class="er">not</span> <span class="er">normalized</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"normal"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Normals</span> <span class="er">at</span> <span class="er">each</span> <span class="er">vertex</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="er">//</span> <span class="er">3</span> <span class="er">components</span> <span class="er">per</span> <span class="er">normal</span> <span class="er">(x</span><span class="fu">,</span> <span class="er">y</span><span class="fu">,</span> <span class="er">z)</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">normals</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"uv"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Texture</span> <span class="er">coordinates</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Each</span> <span class="er">UV</span> <span class="er">coordinate</span> <span class="er">has</span> <span class="er">2</span> <span class="er">components</span><span class="fu">:</span> <span class="er">u</span><span class="fu">,</span> <span class="er">v</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">UV</span> <span class="er">values</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Index</span> <span class="er">data</span> <span class="er">defines</span> <span class="er">the</span> <span class="er">order</span> <span class="er">to</span> <span class="er">connect</span> <span class="er">vertices</span> <span class="er">into</span> <span class="er">triangles</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Uint16Array"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">type</span> <span class="er">of</span> <span class="er">the</span> <span class="er">index</span> <span class="er">array</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span> <span class="er">//</span> <span class="er">Indices</span> <span class="er">forming</span> <span class="er">triangles</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"groups"</span><span class="fu">:</span> <span class="ot">[</span> <span class="er">//</span> <span class="er">Groups</span> <span class="er">specify</span> <span class="er">portions</span> <span class="er">of</span> <span class="er">the</span> <span class="er">geometry</span> <span class="er">that</span> <span class="er">use</span> <span class="er">different</span> <span class="er">materials</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">{</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"start"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Starting</span> <span class="er">index</span> <span class="er">in</span> <span class="er">the</span> <span class="er">index</span> <span class="er">array</span> <span class="er">for</span> <span class="er">this</span> <span class="er">group</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"count"</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Number</span> <span class="er">of</span> <span class="er">indices</span> <span class="er">(here</span><span class="fu">,</span> <span class="er">one</span> <span class="er">quad</span> <span class="er">made</span> <span class="er">of</span> <span class="er">2</span> <span class="er">triangles)</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"materialIndex"</span><span class="fu">:</span> <span class="dv">0</span>  <span class="er">//</span> <span class="er">Which</span> <span class="er">material</span> <span class="er">from</span> <span class="er">the</span> <span class="er">material</span> <span class="er">array</span> <span class="er">should</span> <span class="er">be</span> <span class="er">used</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>          <span class="ot">]</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"material"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metadata"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Metadata</span> <span class="er">about</span> <span class="er">this</span> <span class="er">material</span> <span class="er">export</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"version"</span><span class="fu">:</span> <span class="fl">4.5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Version</span> <span class="er">of</span> <span class="er">the</span> <span class="er">exporter</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Object"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">This</span> <span class="er">is</span> <span class="er">a</span> <span class="er">JSON</span> <span class="er">object</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"generator"</span><span class="fu">:</span> <span class="st">"Material.toJSON"</span> <span class="er">//</span> <span class="er">Generated</span> <span class="er">by</span> <span class="er">Material.toJSON</span> <span class="er">method</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"uuid"</span><span class="fu">:</span> <span class="st">"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Unique</span> <span class="er">ID</span> <span class="er">for</span> <span class="er">the</span> <span class="er">material</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"MeshStandardMaterial"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Type</span> <span class="er">of</span> <span class="er">material</span> <span class="er">(could</span> <span class="er">be</span> <span class="er">MeshBasicMaterial</span><span class="fu">,</span> <span class="er">etc.)</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"color"</span><span class="fu">:</span> <span class="dv">16777215</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Base</span> <span class="er">color</span> <span class="er">(in</span> <span class="er">decimal</span><span class="fu">,</span> <span class="er">here</span> <span class="er">16777215</span> <span class="er">equals</span> <span class="er">0xffffff</span> <span class="er">-</span> <span class="er">white)</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"roughness"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Roughness</span> <span class="er">parameter</span> <span class="er">(controls</span> <span class="er">how</span> <span class="er">rough</span> <span class="er">the</span> <span class="er">surface</span> <span class="er">is)</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metalness"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Metalness</span> <span class="er">parameter</span> <span class="er">(how</span> <span class="er">metallic</span> <span class="er">the</span> <span class="er">material</span> <span class="er">looks)</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"emissive"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Emissive</span> <span class="er">color</span> <span class="er">(self-illumination;</span> <span class="er">0</span> <span class="er">means</span> <span class="er">black</span><span class="fu">,</span> <span class="er">no</span> <span class="er">emission)</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"opacity"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Opacity</span> <span class="er">value</span> <span class="er">(1</span> <span class="er">means</span> <span class="er">fully</span> <span class="er">opaque)</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"transparent"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Flag</span> <span class="er">indicating</span> <span class="er">whether</span> <span class="er">the</span> <span class="er">material</span> <span class="er">supports</span> <span class="er">transparency</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"wireframe"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="er">//</span> <span class="er">If</span> <span class="er">true</span><span class="fu">,</span> <span class="er">the</span> <span class="er">material</span> <span class="er">renders</span> <span class="er">as</span> <span class="er">a</span> <span class="er">wireframe</span> <span class="er">instead</span> <span class="er">of</span> <span class="er">solid</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"side"</span><span class="fu">:</span> <span class="dv">2</span> <span class="er">//</span> <span class="er">Which</span> <span class="er">side</span> <span class="er">of</span> <span class="er">the</span> <span class="er">faces</span> <span class="er">to</span> <span class="er">render</span> <span class="er">(</span><span class="dv">2</span> <span class="er">indicates</span> <span class="er">DoubleSide)</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>  <span class="er">//</span> <span class="er">Other</span> <span class="er">group</span> <span class="er">properties...</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>This is only an example. The above JSON is a simplified version of what Three.js might output when converting an OBJ file into its internal representation. But let’s go over it because the general strokes are the same…</p>
<p>In a <code>BufferGeometry</code>, there’s am <em>index array</em>, which looks as below:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="er">"index":</span> <span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Uint16Array"</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is an optional array that, one that defines how the <em>vertices</em> (which are stored in the <code>attributes.position</code>) are connected to form <em>faces</em> (usually composed of triangles). The values at the indices (the numbers themselves in the <code>index</code> array) refer to the same vertices in the <code>attributes</code> field of the data structure.</p>
<p>For example, let’s say our geometry’s <code>attributes.position</code> field contains the following vertices:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="er">"position":</span> <span class="fu">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">]</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, the index array above (<code>[0, 1, 2, 0, 2, 3]</code>) tells Three.js to use the vertices at positions <code>0, 1, 2</code>, in the position array, to form the first triangle, and vertices at positions <code>0, 2, 3</code> to form the second triangle. Meaning, the points <span class="math inline">\((x,y,z) = (0,0,0)\)</span>, <span class="math inline">\((1,0,0)\)</span>, and <span class="math inline">\((1,1,0)\)</span> form a triangle, as do the points <span class="math inline">\((0,0,0), (1,1,0),\)</span> and <span class="math inline">\((0,1,0)\)</span>. There are two triangles, so the given <code>Mesh</code>’s <code>geometry</code> represents a quad (which can also be seen from the fct that <code>attributes.position</code> contains only 4 vertices).</p>
<p>The <em>starting index</em>, which is the value of <code>group.start</code> in the above object data structure refers to the <em>offset</em> in the above <code>index</code> array where a specific group (which might be assigned one <em>particular</em> material) begins. In simpler terms, it excludes certain faces from having the specified material. In this way, a <code>group</code> basically defines a subset of the index array that should be rendered with a specific material. Of course, the group also defines how many vertices, from the offset, should the material apply to (using <code>group.count</code>), as well as which material to use (using <code>group.materialIndex</code>).</p>
<p>Back to the <a href="./models/rubber_duck.obj">rubber ducky</a> we downloaded earlier, when we look inside the <code>.obj</code> file, the groupings look different – we see syntax like: <code>"o &lt;GroupName&gt;"</code> followed by the vertices. The JSON above is how Three.js interprets the <code>.obj</code>. When we print the rubbery ducky objects to the console we don’t see a group of meshes (as in the JSON above), we see a single mesh. All objects in <code>.obj</code> format are translated into Three.js differently, there’s a lot of variety. The <code>attributes.positions</code> and <code>index</code> arrays always behave the same way, however. The <code>group</code> is just a way to group certain vertices together, it is not a requirement of the OBJ format.</p>
</section>
<section id="homogeneous-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="homogeneous-coordinates">Homogeneous Coordinates</h2>
<p>We use <span class="math inline">\(4 \times 4\)</span> matrices (<code>Matrix4</code>), rather than <span class="math inline">\(3 \times 3\)</span> matrices, to represent transformations in 3D space. But why?</p>
<p>A <span class="math inline">\(3 \times 3\)</span> matrix can handle linear transformations like rotation and scaling, but it cannot handle <em>affine</em> transformations (something as simple as a translation). All linear transformations are affine, but not all affine transformations are linear. As soon as a transformation has a transalation component, it’s no longer linear (it’s affine). A <span class="math inline">\(3 \times 3\)</span> matrix also can’t handle projection (either <em>perspective</em> or <em>orthogonal</em> projection – which are non-linear and linear transformations, respectively).</p>
<p>The <span class="math inline">\(4 \times 4\)</span> matrix incorporates an extra row and column that stores the translation (or projection) components, enabling <em>all</em> simple transformations to be combined into one matrix. This makes it very efficient for computer graphics since we can apply a single matrix to transform an object in 3D space, reducing the number of required matrix operations.</p>
<p>The use of a <span class="math inline">\(4 \times 4\)</span> matrix necessitates the use of <strong>homogeneous coordinates</strong> (which all 3D libraries do under the hood). This is when the normal <span class="math inline">\((x,y,x)\)</span> coordinates are augmented as <span class="math inline">\((x,y,z,w)\)</span> (where <span class="math inline">\(w\)</span> is an extra coordinate that’s <span class="math inline">\(1\)</span> by default). Let’s see how this helps. Suppose we want to translate a point by <span class="math inline">\((t_x, t_y, t_z)\)</span>. In homogeneous coordinates, the translation matrix is:</p>
<p><span class="math display">\[
T = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; t_x \\
0 &amp; 1 &amp; 0 &amp; t_y \\
0 &amp; 0 &amp; 1 &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\]</span></p>
<p>Now, take a point <span class="math inline">\(p\)</span> represented as:</p>
<p><span class="math display">\[
p = \begin{pmatrix} x \\ y \\ z \\ 1 \end{pmatrix}
\]</span></p>
<p>When we apply the translation matrix (identity transformation) to the point, we multiply:</p>
<p><span class="math display">\[
T p = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; t_x \\
0 &amp; 1 &amp; 0 &amp; t_y \\
0 &amp; 0 &amp; 1 &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\begin{pmatrix} x \\ y \\ z \\ 1 \end{pmatrix}
=
\begin{pmatrix}
x + t_x \\
y + t_y \\
z + t_z \\
1
\end{pmatrix}
\]</span></p>
<p>This shows that the point <span class="math inline">\((x, y, z)\)</span> is translated to <span class="math inline">\((x+t_x, y+t_y, z+t_z)\)</span>. We simply mentally discard the extra coordinate.</p>
<p>In summary, the extra coordinate <span class="math inline">\(w\)</span> in homogeneous coordinates enables us to include translation (and projection) in the <em>same</em> framework as other transformations.</p>
</section>
<section id="the-coordinate-system" class="level2">
<h2 class="anchored" data-anchor-id="the-coordinate-system">The Coordinate System</h2>
<p>This is a good time to make an effort to understand the coordinate system in Three.js. We can actually display the axes and the coordinate grid.</p>
<p>Three.js provides a couple of helper classes to visualize the coordinate system in 3D space. The most common ones are <code>AxesHelper</code> and <code>GridHelper</code>.</p>
<p>The <code>AxesHelper</code> displays lines for the <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>, and <span class="math inline">\(z\)</span> axes (typically colored red, green, and blue, respectively). For example:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// An AxesHelper with a size of 50 units</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> axesHelper <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">AxesHelper</span>(<span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(axesHelper)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This helper will render lines originating from the scene’s origin <span class="math inline">\((0, 0, 0)\)</span>, so we can visually see how objects are positioned relative to it.</p>
<p>If we want an additional visual cue that represents a grid on the ground (helpful for orienting objects in a scene), we can use the <code>GridHelper</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A GridHelper with a grid size of 100 and 10 divisions</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> gridHelper <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">GridHelper</span>(<span class="dv">100</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(gridHelper)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, if our grid or axes are not showing up it may be due to the camera’s position. We can point the camera to any vector! Here we point it at the origin.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="fu">lookAt</span>(<span class="kw">new</span> three<span class="op">.</span><span class="fu">Vector3</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adding-multiple-of-the-same-object-to-a-scene-efficiently" class="level2">
<h2 class="anchored" data-anchor-id="adding-multiple-of-the-same-object-to-a-scene-efficiently">Adding Multiple of the Same Object to a Scene (Efficiently)</h2>
<p>Previously we rendered separate scenes in a grid, now let’s see how many ducks we can add to the same scene.</p>
<p>Sure, we might think, let’s just use <code>object.clone()</code> in the <code>OBJLoader</code> callback:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Clone the already loaded duck object</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckClone <span class="op">=</span> object<span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But here’s where we first stumble onto major performance issues in the browser. Depending on how much memory our machine has, we will start noticing jittery behavior and slowed animations when we try to render (roughly) <code>50</code> or more of these rubber ducky objects (that’s the case on my development machine, at least). Luckily, Three.js has an optimization for rendering multiple of the <em>same</em> object to the scene (even if they’re animated differently).</p>
<section id="instanced-mesh" class="level3">
<h3 class="anchored" data-anchor-id="instanced-mesh">Instanced Mesh</h3>
<p>This optimization is called <strong>instancing</strong>. In Three.js, instancing is implemented via the <code>InstancedMesh</code> class, which is what we have to use instead of <code>Mesh</code>. <code>InstancedMesh</code> lets us render many copies of the same mesh (which, recall, is just a pairing of geometry and material) using a <em>single</em> draw call to the GPU (rather than many calls, one per each mesh). Instead of creating a separate <code>Mesh</code> for each object, which will incurs a draw call per object, we can create one <code>InstancedMesh</code>. We can assign each instance its own transformation matrix to vary the object’s position, but its geometry and, to a lesser extent, materials will be fixed. This technique reduces CPU-to-GPU communication overhead, making it ideal for rendering thousands of identical objects efficiently. This is but one of many optimization techniques we can use to render thousands, or even millions of objects to a scene. Another one is using a variable <em>level-of-detail</em> (LOD) for objects that are far away from the camera or player. This technique uses shaders (which we’ll discuss later) to decrease the number of vertices of our geometries if the given mesh is far away from the camera (or a player character). More on that later!</p>
<p>We don’t call <code>clone()</code> for each duck when using instancing. Instead, we create one <code>InstancedMesh</code> that shares the <em>same</em> geometry and material for every instance and then assigns each instance its own transformation matrix. A transformation matrix is just what it sounds like, it’s a matrix supplied to <code>InstancedMesh</code> that applies a <strong>rotation</strong>, a <strong>translation</strong>, and a <strong>scaling</strong> transform. If this matrix sounds like it’s too complicated to come up with on the spot, don’t worry. We will see that its, in fact, very simple and that there are a lot of tricks to help us do just that!</p>
<p><code>InstancedMesh</code> is basically an indexed data structure (a collection like an array) that stores <em>instances</em> of the mesh. These instances aren’t directly accessible, unlike clones. However, we get the next best thing: an interface to update the transformation matrices of the instances (or to apply other instance attributes, like color).</p>
<p>This interface consists of: - A getter method: <code>getMatrixAt(index, matrix)</code> - A setter method <code>setMatrixAt(index, matrix)</code></p>
<p>One question that may arise: Why does the getter method require a <code>matrix</code> parameter? The design of the <code>getMatrixAt</code> method is such that we supply an existing <code>Matrix4</code> as an empty container. The method, then, writes the transformation matrix of the instance at index <code>i</code> (which is stored in the object JSON) into the provided dummy matrix.</p>
<p>But why do we use a <span class="math inline">\(4 \times 4\)</span> matrix in 3D space? For the answer to that, refer to the subsection above on <a href="#homogeneous-coordinates">homogeneous-coordinates</a>. For now, let’s accept this as fact. One tip, when dealing with <code>InstancedMecs</code>, is to avoid re-creating a new <code>Matrix4</code> object on every call and, instead, re-use the same dummy transformation matrix for each call.</p>
<p>Fist, we create an <code>InstancedMesh</code> with <code>N</code> number of ducks. The <code>InstancedMesh</code> constructor takes a single <code>geometry</code> and a single <code>material</code> object (separately). Since the duck <code>.obj</code> comes with 4 child <code>Meshes</code> (each with its own <code>geometry</code> and <code>material</code>) we need separate <code>InstancedMeshes</code> for each of the duck’s parts (for each child <code>Mesh</code>, representing the eyes, beak, wings, and body of the duck). Remember, <code>InstancedMesh</code> just repeats the provided geometry and material over-and-over again (with the only difference being in the transformation matrix that’s applied to each instance).</p>
<p>Let’s review what we need:</p>
<ul>
<li>We need to take each mesh of the duck and create a separate <code>InstancedMesh</code> for each of them.
<ul>
<li>For <code>N</code> ducks, there will be <code>N</code> beaks, <code>N</code> eyes, <code>N</code> wings, and <code>N</code> bodies.</li>
<li>For each of these <code>4N</code> meshes, we need to create a separate <code>InstancedMesh</code> object.</li>
</ul></li>
<li>We need to create <code>N</code> transformation matrices for each of the ducks.
<ul>
<li>This is because while we have <code>4N</code> meshes, we only need <code>N</code> transformation matrices (one for each duck). The same transformation matrix can be applied to all parts of the duck (the beak, eyes, wings, and body).</li>
</ul></li>
</ul>
<p>Here’s the code</p>
<details>
<summary>
Click to expand the code used to create the instanced meshes
</summary>
<div class="sourceCode" id="cb38"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Imports ---------------------------------------------- */</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/build/three.module.js'</span><span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js'</span><span class="op">;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MTLLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js'</span><span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OrbitControls } <span class="im">from</span> <span class="st">"https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js"</span><span class="op">;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Scene / camera / renderer ---------------------------------------- */</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth  <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas6    <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas-6"</span>)<span class="op">;</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene6     <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera6    <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer6  <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({ <span class="dt">canvas</span><span class="op">:</span> canvas6 })<span class="op">;</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>renderer6<span class="op">.</span><span class="fu">setPixelRatio</span>(<span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span>)<span class="op">;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>renderer6<span class="op">.</span><span class="fu">setSize</span>(bodyWidth<span class="op">,</span> bodyHeight)<span class="op">;</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co">/* Lights */</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>scene6<span class="op">.</span><span class="fu">add</span>(<span class="kw">new</span> three<span class="op">.</span><span class="fu">AmbientLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dir <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">DirectionalLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.8</span>)<span class="op">;</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>dir<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>scene6<span class="op">.</span><span class="fu">add</span>(dir)<span class="op">;</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co">/* Skybox */</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>scene6<span class="op">.</span><span class="at">background</span> <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeTextureLoader</span>()<span class="op">.</span><span class="fu">load</span>([</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/px.png'</span><span class="op">,</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nx.png'</span><span class="op">,</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/py.png'</span><span class="op">,</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/ny.png'</span><span class="op">,</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/pz.png'</span><span class="op">,</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nz.png'</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co">/* Controls */</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controls <span class="op">=</span> <span class="kw">new</span> <span class="fu">OrbitControls</span>(camera6<span class="op">,</span> renderer6<span class="op">.</span><span class="at">domElement</span>)<span class="op">;</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">enableDamping</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">dampingFactor</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="co">/* Load duck model --------------------------------------------------- */</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mtlURL <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.mtl'</span><span class="op">;</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> objURL <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.obj'</span><span class="op">;</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">MTLLoader</span>()<span class="op">.</span><span class="fu">load</span>(mtlURL<span class="op">,</span> (materials) <span class="kw">=&gt;</span> {</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>  materials<span class="op">.</span><span class="fu">preload</span>()<span class="op">;</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="fu">OBJLoader</span>()<span class="op">.</span><span class="fu">setMaterials</span>(materials)<span class="op">.</span><span class="fu">load</span>(objURL<span class="op">,</span> (obj) <span class="kw">=&gt;</span> {</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Grab geometries &amp; materials of every duck part ---------------- */</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> geos <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mats <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    obj<span class="op">.</span><span class="fu">traverse</span>((c) <span class="kw">=&gt;</span> { <span class="cf">if</span> (c<span class="op">.</span><span class="at">isMesh</span>) { geos<span class="op">.</span><span class="fu">push</span>(c<span class="op">.</span><span class="at">geometry</span>)<span class="op">;</span> mats<span class="op">.</span><span class="fu">push</span>(c<span class="op">.</span><span class="at">material</span>)<span class="op">;</span> } })<span class="op">;</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Build N shared transform matrices for each N duck *once* ----------------------------- */</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> N <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dummy  <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Object3D</span>()<span class="op">;</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> matrices <span class="op">=</span> []<span class="op">;</span> <span class="co">// store for reuse</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> angle  <span class="op">=</span> (i <span class="op">/</span> N) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> radius <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>      dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(angle)<span class="op">*</span>radius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(angle)<span class="op">*</span>radius)<span class="op">;</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>      dummy<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>      dummy<span class="op">.</span><span class="at">scale</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>      dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>      matrices<span class="op">.</span><span class="fu">push</span>(dummy<span class="op">.</span><span class="at">matrix</span><span class="op">.</span><span class="fu">clone</span>())<span class="op">;</span>   <span class="co">// ⬅️ keep a copy</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* One instanced mesh per part, but use *same* matrices for each of the 4 parts ------------ */</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> meshGroup <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Group</span>()<span class="op">;</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Adding the transformation matrix to each duck part */</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> p <span class="op">&lt;</span> geos<span class="op">.</span><span class="at">length</span><span class="op">;</span> p<span class="op">++</span>) {</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> mesh <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">InstancedMesh</span>(geos[p]<span class="op">,</span> mats[p]<span class="op">,</span> N)<span class="op">;</span> <span class="co">// Make N InstancedMeshes of the duck part</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Set the transform of each N InstancedMesh to one of the N matrices created above</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Note that because of linearity: T(duck) = T(beak) + T(eyes) + T(body)</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>      <span class="co">// So the same transform can be applies to all parts of the duck </span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        mesh<span class="op">.</span><span class="fu">setMatrixAt</span>(i<span class="op">,</span> matrices[i])<span class="op">;</span>    <span class="co">// ⬅️ reuse the matrix</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>      mesh<span class="op">.</span><span class="at">instanceMatrix</span><span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>      meshGroup<span class="op">.</span><span class="fu">add</span>(mesh)<span class="op">;</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>    scene6<span class="op">.</span><span class="fu">add</span>(meshGroup)<span class="op">;</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Camera / animation ------------------------------------------- */</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    camera6<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>    camera6<span class="op">.</span><span class="fu">lookAt</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>      controls<span class="op">.</span><span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>      renderer6<span class="op">.</span><span class="fu">render</span>(scene6<span class="op">,</span> camera6)<span class="op">;</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>    })()<span class="op">;</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Some of the steps involved are explained below.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Build N shared transform matrices for each N duck *once* ----------------------------- */</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> N <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dummy  <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Object3D</span>()<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> matrices <span class="op">=</span> []<span class="op">;</span> <span class="co">// store for reuse</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> angle  <span class="op">=</span> (i <span class="op">/</span> N) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> radius <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(angle)<span class="op">*</span>radius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(angle)<span class="op">*</span>radius)<span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="at">scale</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  matrices<span class="op">.</span><span class="fu">push</span>(dummy<span class="op">.</span><span class="at">matrix</span><span class="op">.</span><span class="fu">clone</span>())<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The step above involves a cool trick. Instead of coming up with a transformation matrix ourselves, we create a <code>dummy</code> object and use its <code>.position.set(x,y,z)</code> to manipulate the dummy object. We give it some rotation (like before). Then we do <code>.updateMatrix()</code> and use the <code>.matrix</code> method to <em>get</em> the object’s transformation matrix. This way we don’t have to worry about the math behind the transformation matrix. We can just use the <code>dummy</code> object to set its position, rotation, and scale.</p>
<p>In the example above we move the <code>dummy</code> object around a circle of <code>radius</code> 40. We subdivide the circle (of <span class="math inline">\(2\pi\)</span> radians) into <code>N</code> segments.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(angle)<span class="op">*</span>radius<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(angle)<span class="op">*</span>radius)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sets the <code>dummy</code> object on the perimeter of the circle.</p>
<p>The <code>dummy</code> object is also rotated by a random angle around its own <span class="math inline">\(y\)</span>-axis.</p>
<p>Once we have this <code>dummy</code> object’s transformation matrix, we provide it to the <code>.setMatrixAt(index, matrix)</code> method of the <code>InstancedMesh</code>.</p>
<p>We then create a Three.js group to capture all the <code>InstancedMeshes</code> to display them easier using the scene’s <code>add()</code> method.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> meshGroup <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Group</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line below is important. It tells Three.js that the transformation matrix of the <code>InstancedMesh</code> has changed and needs to be updated.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mesh<span class="op">.</span><span class="at">instanceMatrix</span><span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we don’t set <code>needsUpdate</code> to <code>true</code>, Three.js won’t know that the matrices have changed (because of the underlying optimizations it makes to cut on GPU workload) and won’t update them in the GPU.</p>
<p>Finally, we need the <code>animate()</code> function to start an animation loop where we can update out <code>controls</code> for <code>OrbitControls</code>, request the animation frame, and render the scene.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  controls<span class="op">.</span><span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  renderer6<span class="op">.</span><span class="fu">render</span>(scene6<span class="op">,</span> camera6)<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>})()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Expand to see the result.</p>
<details>
<summary>
Click to expand
</summary>
<div id="cell-13" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-6'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-6"></canvas>
</div>
</div>
</details>
</section>
</section>
<section id="adding-physics" class="level2">
<h2 class="anchored" data-anchor-id="adding-physics">Adding Physics</h2>
<p>Let’s add some physics to our scene. We can use a popular JavaScript physics engine called <a href="https://schteppe.github.io/cannon.js/">Cannon.js</a>.</p>
<p>First, we include Cannon.js in the <code>include-after-body.text</code> front matter, and import it from a CDN like so:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Like we created a <code>Scene</code> using the Three.js graphics engine, we need to create a <code>World</code> using Cannon.js. The world is where all the physics simulation happens. We can create a world like so:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Physics World</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> world <span class="op">=</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">World</span>()<span class="op">;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>world<span class="op">.</span><span class="at">gravity</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="fl">9.82</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Gravity pointing down</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also need to create a ground plane, otherwise the ducks will keep falling forever. We can create a plane like so:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Ground plane</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> groundBody <span class="op">=</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Body</span>({</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">mass</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// Static body</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">shape</span><span class="op">:</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Plane</span>()<span class="op">,</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>groundBody<span class="op">.</span><span class="at">quaternion</span><span class="op">.</span><span class="fu">setFromEuler</span>(<span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Rotate to be horizontal</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>world<span class="op">.</span><span class="fu">addBody</span>(groundBody)<span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Ground mesh for visualization</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> groundMesh <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> three<span class="op">.</span><span class="fu">PlaneGeometry</span>(<span class="dv">200</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshStandardMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0x808080</span><span class="op">,</span> <span class="dt">side</span><span class="op">:</span> three<span class="op">.</span><span class="at">DoubleSide</span> })</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>groundMesh<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">=</span> <span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>scene6<span class="op">.</span><span class="fu">add</span>(groundMesh)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we need to create a <code>cannon.Body</code> for the ground plane <code>Mesh</code>. Any object that we want to be affected by physics needs to be a <code>cannon.Body</code>. We also need to set the <code>quaternion</code> of the ground plane to be horizontal (the default is vertical). The <code>mass</code> property is set to <code>0</code>, which makes this body static. Static bodies do not move under the influence of forces or collisions—they are immovable objects in the simulation. This is ideal for objects like the ground or walls.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>groundBody<span class="op">.</span><span class="at">quaternion</span><span class="op">.</span><span class="fu">setFromEuler</span>(<span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Rotate to be horizontal</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line above sets the rotation of the ground plane to be horizontal. The <code>quaternion</code> is a way to represent rotations in 3D space. The <code>setFromEuler</code> method takes three angles (in radians) representing rotations around the <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>, and <span class="math inline">\(z\)</span> axes, respectively. In the context of 3D graphics and physics, <a href="https://en.wikipedia.org/wiki/Quaternion">quaternions</a> are widely used because they provide a robust and efficient way to handle rotations. They avoid common problems associated with other rotation representations, such as <a href="https://en.wikipedia.org/wiki/Gimbal_lock#:~:text=In%20formal%20language%2C%20gimbal%20lock,which%20point%20gimbal%20lock%20occurs.">gimbal lock</a>, which can occur when using Euler angles. More on gimbal lock and quaternions later…</p>
<p>We also need to create a <code>cannon.Body</code> for each duck. We can do this in the <code>OBJLoader</code> callback, where we load the duck model. For the duck shape, we can use a <code>cannon.Sphere</code> shape for simplicity (for now).</p>
<p>As before, the positions and rotations of the physics bodies are applied to the <code>InstancedMesh</code> instances using a <code>dummy</code> object.</p>
<p>The physics world is stepped forward using <code>world.step</code>, and the positions of the ducks are updated based on the physics simulation.</p>
<p>In summary:</p>
<ol type="1">
<li><strong>Physics World</strong>:
<ul>
<li>A <code>cannon.World</code> is created with gravity pointing downward.</li>
<li>A ground plane is added to stop the ducks from falling infinitely.</li>
</ul></li>
<li><strong>Duck Physics Bodies</strong>:
<ul>
<li>Each duck is assigned a <code>cannon.Body</code> with a <code>cannon.Sphere</code> shape for simplicity.</li>
<li>The positions of the <em>physics bodies</em> are updated in the animation loop.</li>
</ul></li>
<li><strong>Synchronizing Physics and Graphics</strong>:
<ul>
<li>The positions and rotations of the physics bodies are applied to the <code>InstancedMesh</code> instances using a <code>dummy</code> object.</li>
</ul></li>
<li><strong>Animation Loop</strong>:
<ul>
<li>The physics world is stepped forward using <code>world.step</code>.</li>
<li>The positions of the ducks are updated based on the physics simulation.</li>
</ul></li>
</ol>
<p>Let’s see the code:</p>
<details>
<summary>
Click to expand the code used to add physics
</summary>
<div class="sourceCode" id="cb49"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/+esm'</span><span class="op">;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js'</span><span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MTLLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js'</span><span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OrbitControls } <span class="im">from</span> <span class="st">'https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js'</span><span class="op">;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> cannon <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js'</span><span class="op">;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Scene / Ccmera / renderer ---------------------------------------------- */</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)<span class="op">;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({ <span class="dt">canvas</span><span class="op">:</span> canvas })<span class="op">;</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>(<span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span>)<span class="op">;</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>(bodyWidth<span class="op">,</span> bodyHeight)<span class="op">;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="co">/* Lights ---------------------------------------------- */</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(<span class="kw">new</span> three<span class="op">.</span><span class="fu">AmbientLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dir <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">DirectionalLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.8</span>)<span class="op">;</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>dir<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(dir)<span class="op">;</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="co">/* Physics World ---------------------------------------------- */</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> world <span class="op">=</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">World</span>()<span class="op">;</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>world<span class="op">.</span><span class="at">gravity</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="fl">9.82</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Gravity pointing down</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Ground plane</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> groundBody <span class="op">=</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Body</span>({</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">mass</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// Static body</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">shape</span><span class="op">:</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Plane</span>()<span class="op">,</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>groundBody<span class="op">.</span><span class="at">quaternion</span><span class="op">.</span><span class="fu">setFromEuler</span>(<span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Rotate to be horizontal</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>world<span class="op">.</span><span class="fu">addBody</span>(groundBody)<span class="op">;</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Ground mesh for visualization</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> groundMesh <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> three<span class="op">.</span><span class="fu">PlaneGeometry</span>(<span class="dv">200</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshStandardMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0x808080</span><span class="op">,</span> <span class="dt">side</span><span class="op">:</span> three<span class="op">.</span><span class="at">DoubleSide</span> })</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>groundMesh<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">=</span> <span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(groundMesh)<span class="op">;</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="co">/* Load duck model ---------------------------------------------- */</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mtlURL <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.mtl'</span><span class="op">;</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> objURL <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.obj'</span><span class="op">;</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">MTLLoader</span>()<span class="op">.</span><span class="fu">load</span>(mtlURL<span class="op">,</span> (materials) <span class="kw">=&gt;</span> {</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>  materials<span class="op">.</span><span class="fu">preload</span>()<span class="op">;</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="fu">OBJLoader</span>()<span class="op">.</span><span class="fu">setMaterials</span>(materials)<span class="op">.</span><span class="fu">load</span>(objURL<span class="op">,</span> (obj) <span class="kw">=&gt;</span> {</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> geos <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mats <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    obj<span class="op">.</span><span class="fu">traverse</span>((c) <span class="kw">=&gt;</span> {</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (c<span class="op">.</span><span class="at">isMesh</span>) {</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>        geos<span class="op">.</span><span class="fu">push</span>(c<span class="op">.</span><span class="at">geometry</span>)<span class="op">;</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>        mats<span class="op">.</span><span class="fu">push</span>(c<span class="op">.</span><span class="at">material</span>)<span class="op">;</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> N <span class="op">=</span> <span class="dv">50</span><span class="op">;</span> <span class="co">// Number of ducks</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dummy <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Object3D</span>()<span class="op">;</span></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> meshGroup <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Group</span>()<span class="op">;</span></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duckBodies <span class="op">=</span> []<span class="op">;</span> <span class="co">// Store physics bodies</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> p <span class="op">&lt;</span> geos<span class="op">.</span><span class="at">length</span><span class="op">;</span> p<span class="op">++</span>) {</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> mesh <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">InstancedMesh</span>(geos[p]<span class="op">,</span> mats[p]<span class="op">,</span> N)<span class="op">;</span></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Random initial positions</span></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> x <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">50</span> <span class="op">-</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> y <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="dv">50</span><span class="op">;</span> <span class="co">// Start above the ground</span></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> z <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">50</span> <span class="op">-</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a physics body for each duck</span></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> duckBody <span class="op">=</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Body</span>({</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>          <span class="dt">mass</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="co">// Dynamic body</span></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>          <span class="dt">shape</span><span class="op">:</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Sphere</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="co">// Approximate shape</span></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>          <span class="dt">position</span><span class="op">:</span> <span class="kw">new</span> cannon<span class="op">.</span><span class="fu">Vec3</span>(x<span class="op">,</span> y<span class="op">,</span> z)<span class="op">,</span></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>        world<span class="op">.</span><span class="fu">addBody</span>(duckBody)<span class="op">;</span></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>        duckBodies<span class="op">.</span><span class="fu">push</span>(duckBody)<span class="op">;</span></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set initial transformation for the InstancedMesh</span></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(x<span class="op">,</span> y<span class="op">,</span> z)<span class="op">;</span></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="at">scale</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a>        mesh<span class="op">.</span><span class="fu">setMatrixAt</span>(i<span class="op">,</span> dummy<span class="op">.</span><span class="at">matrix</span>)<span class="op">;</span></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>      mesh<span class="op">.</span><span class="at">instanceMatrix</span><span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>      meshGroup<span class="op">.</span><span class="fu">add</span>(mesh)<span class="op">;</span></span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>    scene<span class="op">.</span><span class="fu">add</span>(meshGroup)<span class="op">;</span></span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Camera / Animation ---------------------------------------------- */</span></span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">lookAt</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Step the physics world</span></span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>      world<span class="op">.</span><span class="fu">step</span>(<span class="dv">1</span> <span class="op">/</span> <span class="dv">30</span>)<span class="op">;</span> <span class="co">// 120 FPS</span></span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update the positions of the ducks</span></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> duckBody <span class="op">=</span> duckBodies[i]<span class="op">;</span></span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> position <span class="op">=</span> duckBody<span class="op">.</span><span class="at">position</span><span class="op">;</span></span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> quaternion <span class="op">=</span> duckBody<span class="op">.</span><span class="at">quaternion</span><span class="op">;</span></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(position<span class="op">.</span><span class="at">x</span><span class="op">,</span> position<span class="op">.</span><span class="at">y</span><span class="op">,</span> position<span class="op">.</span><span class="at">z</span>)<span class="op">;</span></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="at">quaternion</span><span class="op">.</span><span class="fu">set</span>(quaternion<span class="op">.</span><span class="at">x</span><span class="op">,</span> quaternion<span class="op">.</span><span class="at">y</span><span class="op">,</span> quaternion<span class="op">.</span><span class="at">z</span><span class="op">,</span> quaternion<span class="op">.</span><span class="at">w</span>)<span class="op">;</span></span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>        dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>        meshGroup<span class="op">.</span><span class="at">children</span><span class="op">.</span><span class="fu">forEach</span>((mesh) <span class="kw">=&gt;</span> {</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>          mesh<span class="op">.</span><span class="fu">setMatrixAt</span>(i<span class="op">,</span> dummy<span class="op">.</span><span class="at">matrix</span>)<span class="op">;</span></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>      meshGroup<span class="op">.</span><span class="at">children</span><span class="op">.</span><span class="fu">forEach</span>((mesh) <span class="kw">=&gt;</span> {</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>        mesh<span class="op">.</span><span class="at">instanceMatrix</span><span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>      controls<span class="op">.</span><span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>      renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">animate</span>()<span class="op">;</span></span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a><span class="co">/* Orbit Controls ---------------------------------------------- */</span></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controls <span class="op">=</span> <span class="kw">new</span> <span class="fu">OrbitControls</span>(camera<span class="op">,</span> renderer<span class="op">.</span><span class="at">domElement</span>)<span class="op">;</span></span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">enableDamping</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">dampingFactor</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>We also added a metalic pool, feel free to see the full code <a href="./javascript/three-js-many-ducks-physics-demo.js">here</a>.</p>
<p>Finally, even though the gravitational constant is set to the same value as on Earth, the ducks appear to fall very slowly due to the scale of the scene. We can speed things up using:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Step the physics world multiple times per frame</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++</span>) {  <span class="co">// Simulate physics 3x per animation frame</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    world<span class="op">.</span><span class="fu">step</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">60</span>)<span class="op">;</span>         <span class="co">// Standard 60 FPS physics simulation</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From the docs:</p>
<p><code>world.step(timeStep)</code> takes parameter:</p>
<ol type="1">
<li><code>timeStep</code> (required): The time step to simulate, in seconds. For example:
<ul>
<li><code>1/60</code> simulates physics at 60 FPS</li>
<li><code>1/120</code> simulates physics at 120 FPS</li>
<li>The smaller the timestep, the more accurate but computationally expensive the simulation</li>
</ul></li>
</ol>
<p>There are more parameters but they are optional.</p>
<p>The crucial thing to understand is that physics steps and animation frames are decoupled. The physics world is updated independently of the rendering loop. This means we can run the physics simulation at a different rate than the rendering loop. The rendering loop is variable, and based on our monitor refresh rate (usually it’s 60 FPS). The physics world can be updated at a different rate than that. The key is that the physics world should be updated at a <em>fixed</em> time step. This is important for stability and accuracy in the simulation.</p>
<p>So when we do 3 physics steps within one animation (steps of <span class="math inline">\(1/60\)</span> seconds each in terms of time <span class="math inline">\(t\)</span> that’s supplied to the physics engine), the physics simulation advances by a total of <span class="math inline">\(3/60 = 1/20\)</span> seconds. But we only show the final result after all 3 steps are done (hence why we don’t need 3 corresponding animation frames). The next animation frame will start from this new state. This has the effect of speeding up our animation since each animation frame now displays the objects further along their journey (the trajectory of their motion).</p>
<p>Running one step of <span class="math inline">\(1/20\)</span>-th second instead, as below, is inappropiate:</p>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>world.step(<span class="dv">1</span><span class="op">/</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While mathematically <span class="math inline">\(1/20 = 3*(1/60)\)</span>, they’re not equivalent for physics simulation because physics engines use <em>numerical integration</em> to calculate the motion of objects. Using larger time steps (like <span class="math inline">\(1/20\)</span>) leads to less accurate results because the engine has to approximate motion over a longer period. As we know, local approximation is always available but as we move far away from the known point, methods like <a href="https://en.wikipedia.org/wiki/Taylor_series">Taylor Series</a> start losing accuracy. Smaller time steps <span class="math inline">\(1/60\)</span> or <span class="math inline">\(1/120\)</span> allow the engine to calculate positions and velocities more frequently, leading to more accurate simulation. With larger time steps fast-moving objects might also experience clipping issues (because their positions are updated less frequently).</p>
<p>In fact, the approach we used is known as <a href="https://www.unrealengine.com/es-ES/blog/physics-sub-stepping">physics <em>sub-stepping</em></a>. The article goes over on how to enable sub-stepping in Unreal Engine, but the concept is the same. The idea is to run the physics simulation at a higher frequency than the rendering loop. This allows for more accurate and stable simulations, especially for fast-moving objects or complex interactions.</p>
<p>Let’s see the result.</p>
<details>
<summary>
Click to expand
</summary>
<div id="cell-20" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-7'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-7"></canvas>
</div>
</div>
</details>
<p>Of course, there are several things that are still <em>very</em> wrong with our scene:</p>
<ul>
<li>The ducks shouldn’t be rolling like billiards balls. We can fix that by using a more accurate shape for the ducks (instead of a sphere). For example, we can use a <code>cannon.ConvexPolyhedron</code>, which is a more accurate representation of the duck’s shape. This will make the ducks fall more realistically in the above physics simulation.</li>
<li>We need to implement <em>buoyancy</em> to the water, it would be nice if the water didn’t behave like the surface of a table. However, this will have to do for now.</li>
<li>It would be nice if the walls reflected the ducks as well as the water’s surface.</li>
</ul>
<p>But, we will revisit this scene later and make it more believable. For now, let’s move on to the next section. A section I am very excited to introduce, <a href="#shaders">Shaders</a>.</p>
</section>
<section id="shaders" class="level2">
<h2 class="anchored" data-anchor-id="shaders">Shaders</h2>
<p>From making the surface of water realistic, to rendering realistic grass, <em>shaders</em> are the backbone of modern graphics programming. They are used for ultimate control over the rendering pipeline. Think of them as functions that map a vertex or a pixel to an RGBA color.</p>
<p><span class="math display">\[
f(x,y,z) = (x,y,z) \to (r,g,b,a)
\]</span></p>
<p>Some shaders also map a vertex to another vertex, effectively acting as a transformation function. This can help create, for example, a <em>displacement map</em> that distorts the surface of an object based on a texture (for rending things like waves in a body of water). These types of shaders look like:</p>
<p><span class="math display">\[
f(x,y,z) = (x,y,z) \to (x',y',z')
\]</span></p>
<p>Shaders are, basically, small programs (scripts) that run on the GPU and are used to control the rendering of graphics. They are written in a language called GLSL (OpenGL Shading Language). Shaders define how vertices and pixels are processed, allowing for advanced visual effects. Shaders are typically divided into two main types: <strong>vertex shaders</strong> and <strong>fragment shaders</strong>.</p>
<ul>
<li><strong>Vertex Shaders</strong>: These shaders are responsible for processing each vertex of a 3D model. They take vertex attributes (like position, normal, and texture coordinates) and transform them into screen space.</li>
<li><strong>Fragment Shaders</strong>: These shaders are responsible for processing each pixel (or fragment) of a rendered image. They determine the final color of each pixel based on various factors, such as lighting, textures, and material properties. Fragment shaders can create complex visual effects like shadows, reflections, and refractions.</li>
</ul>
<section id="how-to-use-shaders-from-three.js" class="level3">
<h3 class="anchored" data-anchor-id="how-to-use-shaders-from-three.js">How to Use Shaders from Three.js</h3>
<p>First, let’s see how we can use shaders in Three.js. Three.js provides a <code>ShaderMaterial</code> class that allows us to create render vertex and fragment shaders. We can define our own GLSL code for both of these (the vertex and fragment shaders) and provide them to <code>ShaderMaterial</code>.</p>
<p>The GLSL code is typically split into two parts. Usually it’s split into <code>&lt;shader_name&gt;.frag</code> and <code>&lt;shader_name&gt;.vert</code> files: the vertex shader and the fragment shader. As mentioned before, the vertex shader is responsible for transforming the vertices of the geometry, while the fragment shader is responsible for determining the color of each pixel.</p>
<p>First, we import the GLSL shader code into JavaScript. Importing is fancy for: creating a <code>waterVertexShader</code> and a <code>waterFragmentShader</code> string literal containing the GLSL code inside our JavaScript like so:</p>
<details>
<summary>
Click to expand the code used to create the water shader
</summary>
<div class="sourceCode" id="cb53"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> waterVertexShader <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform vec3 uDepthColor;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform vec3 uSurfaceColor;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float uColorOffset;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float uColorMultiplier;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  varying float vElevation;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  void main()</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  {</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      float mixStrenght = (vElevation  + uColorOffset)* uColorMultiplier;</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      vec3 color = mix(uDepthColor,uSurfaceColor,mixStrenght) ;</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="vs">      gl_FragColor = vec4(color,1.0);</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="vs">  }</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span><span class="op">;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> waterFragmentShader <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float uTime;</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float uBigWavesElevation;</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform vec2 uBigWavesFrequency;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float uBigWavesSpeed;</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float  uSmallWavesElevation;</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float  uSmallWavesFrequency;</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float  uSmallWavesSpeed;</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="vs">  uniform float  uSmallWavesIterations;</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="vs">  varying float vElevation;</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="vs">  //    Classic Perlin 3D Noise </span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="vs">  //    by Stefan Gustavson</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="vs">  //</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="vs">  vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="vs">  vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="vs">  vec3 fade(vec3 t) {return t*t*t*(t*(t*6.0-15.0)+10.0);}</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="vs">  float cnoise(vec3 P){</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 Pi0 = floor(P); // Integer part for indexing</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 Pi1 = Pi0 + vec3(1.0); // Integer part + 1</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="vs">    Pi0 = mod(Pi0, 289.0);</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="vs">    Pi1 = mod(Pi1, 289.0);</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 Pf0 = fract(P); // Fractional part for interpolation</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 iy = vec4(Pi0.yy, Pi1.yy);</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 iz0 = Pi0.zzzz;</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 iz1 = Pi1.zzzz;</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 ixy = permute(permute(ix) + iy);</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 ixy0 = permute(ixy + iz0);</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 ixy1 = permute(ixy + iz1);</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gx0 = ixy0 / 7.0;</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gy0 = fract(floor(gx0) / 7.0) - 0.5;</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a><span class="vs">    gx0 = fract(gx0);</span></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 sz0 = step(gz0, vec4(0.0));</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="vs">    gx0 -= sz0 * (step(0.0, gx0) - 0.5);</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="vs">    gy0 -= sz0 * (step(0.0, gy0) - 0.5);</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gx1 = ixy1 / 7.0;</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gy1 = fract(floor(gx1) / 7.0) - 0.5;</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a><span class="vs">    gx1 = fract(gx1);</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 sz1 = step(gz1, vec4(0.0));</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="vs">    gx1 -= sz1 * (step(0.0, gx1) - 0.5);</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="vs">    gy1 -= sz1 * (step(0.0, gy1) - 0.5);</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);</span></span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a><span class="vs">    g000 *= norm0.x;</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a><span class="vs">    g010 *= norm0.y;</span></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a><span class="vs">    g100 *= norm0.z;</span></span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="vs">    g110 *= norm0.w;</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a><span class="vs">    g001 *= norm1.x;</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a><span class="vs">    g011 *= norm1.y;</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a><span class="vs">    g101 *= norm1.z;</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a><span class="vs">    g111 *= norm1.w;</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n000 = dot(g000, Pf0);</span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));</span></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));</span></span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));</span></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));</span></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n111 = dot(g111, Pf1);</span></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec3 fade_xyz = fade(Pf0);</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);</span></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a><span class="vs">    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); </span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a><span class="vs">    return 2.2 * n_xyz;</span></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a><span class="vs">  }</span></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a><span class="vs">  void main()</span></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a><span class="vs">  {</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a><span class="vs">      vec4 modelPosition = modelMatrix * vec4(position,1.0);</span></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="vs">      //elevation </span></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a><span class="vs">      float elevation = sin(modelPosition.x * uBigWavesFrequency.x + uTime * uBigWavesSpeed ) </span></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a><span class="vs">                      * sin(modelPosition.z * uBigWavesFrequency.y + uTime * uBigWavesSpeed)</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="vs">                      * uBigWavesElevation;</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a><span class="vs">      for(float i = 1.0 ; i &lt;= uSmallWavesIterations ; i++)</span></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="vs">      {</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        elevation -= abs(</span></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a><span class="vs">            cnoise(</span></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a><span class="vs">                vec3(</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a><span class="vs">                    modelPosition.xz * uSmallWavesFrequency * i,</span></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a><span class="vs">                    uTime*uSmallWavesSpeed</span></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a><span class="vs">                    )</span></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a><span class="vs">                    ) * uSmallWavesElevation / i</span></span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a><span class="vs">                    );</span></span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="vs">      modelPosition.y += elevation;</span></span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a><span class="vs">      vec4 viewPosition = viewMatrix * modelPosition;</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a><span class="vs">      vec4 projectedPosition = projectionMatrix * viewPosition;</span></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a><span class="vs">      gl_Position = projectedPosition;</span></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a><span class="vs">      vElevation = elevation;</span></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="vs">  }</span></span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Then we can create a <code>ShaderMaterial</code> using the vertex and fragment shaders:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> waterMaterial <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">ShaderMaterial</span>({</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uniforms</span><span class="op">:</span> {</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">time</span><span class="op">:</span> { <span class="dt">value</span><span class="op">:</span> <span class="dv">0</span> }<span class="op">,</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">waterColor</span><span class="op">:</span> { <span class="dt">value</span><span class="op">:</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Color</span>(<span class="bn">0x1E90FF</span>) }<span class="op">,</span> <span class="co">// Water color</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">envMap</span><span class="op">:</span> { <span class="dt">value</span><span class="op">:</span> scene<span class="op">.</span><span class="at">background</span> }<span class="op">,</span> <span class="co">// Environment map for reflection</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vertexShader</span><span class="op">:</span> waterVertexShader<span class="op">,</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fragmentShader</span><span class="op">:</span> waterFragmentShader<span class="op">,</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, we apply the <code>waterMaterial</code> at the time of <code>Mesh</code> creation:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> waterMesh <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> three<span class="op">.</span><span class="fu">PlaneGeometry</span>(<span class="dv">200</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    waterMaterial</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s render the result.</p>
<details>
<summary>
Click to expand
</summary>
<div id="cell-22" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-8'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-8"></canvas>
</div>
</div>
</details>
<p>But how does this work? Here’s a <a href="../../../unpublished_posts/game_development/computer_graphics/computer_graphics.html">shader post</a> that goes over it in detail. For us, for now, at a <em>very</em> high level:</p>
<ul>
<li>Vertex and fragment shaders use <em>uniforms</em> to keep track of state (between themselves as well as the outside JavaScript world)</li>
<li>We run the scene (our simulation or animation) in Three.js and pass the time (from the physics simulation) to the shader using <code>uniforms</code>. Then, the shader can be a function of time…</li>
<li>Position information can be passed into the shaders, for example, to achieve the effect of a surface appearing more reflective further away.</li>
</ul>
<p>Once again, here’s the full <a href="../../../unpublished_posts/game_development/computer_graphics/computer_graphics.html">post on shaders and GLSL</a> if you’re interested to explore this topic further.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, we explored how to create a scene with multiple ducks using Three.js. We learned how to use <code>InstancedMesh</code> to efficiently render many instances of the same geometry. We also added physics to our scene using Cannon.js, allowing the ducks to interact with the environment realistically. Finally, we introduced shaders. We used Three.js to apply a custom water shader written in GLSL. This post is part of a series on <a href="https://threejs.org/">Three.js</a>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/v-poghosyan\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2021, Vahram Poghosyan</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/v-poghosyan">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/vahrampoghosyan/">
      <i class="bi bi-linkedin" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script type="application/javascript" src="../../../javascript/light-dark.js"></script>
<script type="importmap">
  {
      "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.173.0/+esm",
          "OBJLoader": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js",
          "MTLLoader": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js",
          "OrbitControls": "https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js",
          "Cannon": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
      }
  }
</script>
<script type="module" src="./javascript/three-js-demo.js"></script>
<script type="module" src="./javascript/three-js-grid-demo.js"></script>
<script type="module" src="./javascript/three-js-duck-demo.js"></script>
<script type="module" src="./javascript/three-js-many-ducks-demo.js"></script>
<script type="module" src="./javascript/three-js-many-ducks-physics-demo.js"></script>
<script type="module" src="./javascript/three-js-shader-demo.js"></script>




</body></html>