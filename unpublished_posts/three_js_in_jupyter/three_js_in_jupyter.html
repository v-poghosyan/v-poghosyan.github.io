<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vahram Poghosyan">
<meta name="dcterms.date" content="2024-12-26">

<title>Three.js - 3D Animations in the Browser – v-poghosyan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KLCX05QFPN"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-KLCX05QFPN', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="./css/three-js-demo.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/site/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">v-poghosyan</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Info</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">Three.js - 3D Animations in the Browser</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Three.js</div>
                <div class="quarto-category">Visualization</div>
                <div class="quarto-category">JavaScript</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Vahram Poghosyan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 26, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#three.js-webgl-and-canvas-api" id="toc-three.js-webgl-and-canvas-api" class="nav-link" data-scroll-target="#three.js-webgl-and-canvas-api">Three.js, WebGL, and Canvas API</a></li>
  <li><a href="#d-scenes---a-primer" id="toc-d-scenes---a-primer" class="nav-link" data-scroll-target="#d-scenes---a-primer">3D Scenes - A Primer</a>
  <ul>
  <li><a href="#meshes-objects-geometries-and-materials" id="toc-meshes-objects-geometries-and-materials" class="nav-link" data-scroll-target="#meshes-objects-geometries-and-materials">Meshes, Objects, Geometries, and Materials</a></li>
  </ul></li>
  <li><a href="#our-first-canvas" id="toc-our-first-canvas" class="nav-link" data-scroll-target="#our-first-canvas">Our First Canvas</a>
  <ul>
  <li><a href="#creating-a-scene" id="toc-creating-a-scene" class="nav-link" data-scroll-target="#creating-a-scene">Creating a Scene</a></li>
  <li><a href="#defining-scene-properties-and-selecting-a-canvas" id="toc-defining-scene-properties-and-selecting-a-canvas" class="nav-link" data-scroll-target="#defining-scene-properties-and-selecting-a-canvas">Defining Scene Properties and Selecting a Canvas</a></li>
  <li><a href="#creating-a-camera" id="toc-creating-a-camera" class="nav-link" data-scroll-target="#creating-a-camera">Creating a Camera</a></li>
  <li><a href="#creating-a-webgl-renderer" id="toc-creating-a-webgl-renderer" class="nav-link" data-scroll-target="#creating-a-webgl-renderer">Creating a WebGL Renderer</a></li>
  <li><a href="#rendering-the-scene-and-adding-objects" id="toc-rendering-the-scene-and-adding-objects" class="nav-link" data-scroll-target="#rendering-the-scene-and-adding-objects">Rendering the Scene and Adding Objects</a></li>
  <li><a href="#adding-animations" id="toc-adding-animations" class="nav-link" data-scroll-target="#adding-animations">Adding animations</a></li>
  </ul></li>
  <li><a href="#optional-grid-view-in-jupyter-notes" id="toc-optional-grid-view-in-jupyter-notes" class="nav-link" data-scroll-target="#optional-grid-view-in-jupyter-notes">(Optional) Grid View in Jupyter Notes</a></li>
  <li><a href="#loading-custom-objects-with-materials" id="toc-loading-custom-objects-with-materials" class="nav-link" data-scroll-target="#loading-custom-objects-with-materials">Loading Custom Objects with Materials</a></li>
  <li><a href="#adding-controls" id="toc-adding-controls" class="nav-link" data-scroll-target="#adding-controls">Adding Controls</a></li>
  <li><a href="#the-obj-representation-of-an-object" id="toc-the-obj-representation-of-an-object" class="nav-link" data-scroll-target="#the-obj-representation-of-an-object">The OBJ Representation of an Object</a></li>
  <li><a href="#creating-complex-scenes" id="toc-creating-complex-scenes" class="nav-link" data-scroll-target="#creating-complex-scenes">Creating Complex Scenes</a>
  <ul>
  <li><a href="#adding-multiple-of-the-same-object-to-a-scene" id="toc-adding-multiple-of-the-same-object-to-a-scene" class="nav-link" data-scroll-target="#adding-multiple-of-the-same-object-to-a-scene">Adding Multiple of the Same Object to a Scene</a>
  <ul class="collapse">
  <li><a href="#instanced-mesh" id="toc-instanced-mesh" class="nav-link" data-scroll-target="#instanced-mesh">Instanced Mesh</a>
  <ul class="collapse">
  <li><a href="#merging-meshes-while-preserving-materials" id="toc-merging-meshes-while-preserving-materials" class="nav-link" data-scroll-target="#merging-meshes-while-preserving-materials">Merging Meshes while Preserving Materials</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#homogeneous-coordinates---linearaffine-transformations" id="toc-homogeneous-coordinates---linearaffine-transformations" class="nav-link" data-scroll-target="#homogeneous-coordinates---linearaffine-transformations">Homogeneous Coordinates - Linear/Affine Transformations</a></li>
  <li><a href="#the-coordinate-system-in-three.js" id="toc-the-coordinate-system-in-three.js" class="nav-link" data-scroll-target="#the-coordinate-system-in-three.js">The Coordinate System in Three.js</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this post we use <a href="https://threejs.org/">Three.js</a> external scripts to render 3D scenes inside this Jupyter notebook.</p>
<p>This post will be very similar, in terms of its stack, to the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US map post</a>.</p>
<p>In <em>that</em> post, we learned that Canvas and SVG are two ways in which we can display complex graphics inside a web browser. We already explored SVG graphics in <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US map</a>. It’s worth noting that a lot of the same functionality could’ve been replicated using the HTML Canvas element instead of SVG (which we ultimately chose for its superior interactive capabilities) – the article mentions one way to do that by using <a href="https://github.com/samizdatco/skia-canvas">skia-canvas</a>.</p>
<p>We ended up using <a href="https://github.com/WebReflection/linkedom#readme">linkedom</a> to add a DOM API on top of the Deno environment.</p>
<p>In fact, what I realized later on is that we could’ve simply used the Markdown inside our Jupyter notebook to create the <code>&lt;svg&gt;</code> element without the need to introduce a third-party DOM API on top of a browser-less JavaScript environment (Deno). Then, we could have simply fetched the <code>TopoJSON</code> data and constructed the map inside our external scripts with the rest of the complex D3 animations that had to be added as external scripts. These scripts are run by Quarto only <em>after</em> the page has been rendered to the browser, so we can easily reference the DOM elements we create inside our notes by <code>class</code> or <code>id</code>. Crucially, the external scripts are meant to run <em>inside the browser</em> (as opposed to being pre-computed in the browser-less Deno environment). Inside the browser they’re able to leverage the existing DOM API provided by the browser’s engine (e.g.&nbsp;<code>document.getElementById</code>). Hence, this way, we eliminate the need for Deno as well as Linkedom.</p>
<p>We will use the <a href="https://ipython.readthedocs.io/en/8.26.0/api/generated/IPython.display.html">IPython.display</a> module to create HTML elements inside our notes rather than just using Markdown directly.</p>
</section>
<section id="three.js-webgl-and-canvas-api" class="level1">
<h1>Three.js, WebGL, and Canvas API</h1>
<p><a href="https://threejs.org/">Three.js</a> is a library for drawing 3D graphics in the browser using JavaScript and <a href="https://get.webgl.org/">WebGL</a> (see <a href="https://www.khronos.org/webgl/wiki/Main_Page">wiki</a>). One excellent resource for learning WebGL is the <a href="https://webglfundamentals.org/webgl/lessons">WebGLFundamentals</a> website.</p>
<p>WebGL runs in an HTML Canvas (i.e.&nbsp;<code>&lt;canvas&gt;</code>).</p>
<p>From the WebGL wiki:</p>
<blockquote class="blockquote">
<p>WebGL is a DOM API, which means that it can be used in any DOM-compatible language: e.g.&nbsp;JavaScript</p>
</blockquote>
<p>Three.js is a library that provides conveniences in JavaScript that abstract much of this <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API">WebGL</a> DOM API calls behind friendlier JavaScript code.</p>
<p>Note that WebGL and Canvas API are two distinct ways in which the browser draws graphics, but they both require and HTML Canvas to draw on. Three.js offers a WebGL renderer as well as a Canvas renderer. Canvas API is usually a fallback option for when WebGL, the more powerful of the two APIs, isn’t available.</p>
<p>Note, also, that Three.js isn’t suitable for modelling purposes, for that we can use <a href="https://www.blender.org/">Blender</a> or a number of other closed-source 3D modelling applications. We can even download or purchase third-party models from vendors.</p>
<p>Canvas and SVG elements are two ways in which we can display complex graphics inside a web browser. We already explored SVG graphics in the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js interactive US Map</a> post. It’s worth noting that a lot of the same functionality could’ve been achieved by using the HTML Canvas element with D3.js instead. The post above mentions one way to do that by using <a href="https://github.com/samizdatco/skia-canvas">skia-canvas</a>.</p>
<p>In this post we use Three.js, and not D3.js, to draw inside an HTML Canvas element using, not the Canvas API, but rather WebGL.</p>
</section>
<section id="d-scenes---a-primer" class="level1">
<h1>3D Scenes - A Primer</h1>
<p>In <em>any</em> 3D scene, be it in the web browser, inside a game engine, in a movie, in a 3D modelling application, etc. there are a bunch of <strong>geometries</strong>, or <strong>shapes</strong> that are packaged with <strong>materials</strong> as <strong>meshes</strong>. The materials can describe simple properties like reflectivity, opacity, refraction index, etc. or they can be <strong>textures</strong> which are just simple <a href="https://en.wikipedia.org/wiki/Raster_graphics">raster</a> images. We can also apply <strong>shaders</strong> to our objects, which are complex mappings of pixels (or vertices) that make up an interesting animation.</p>
<p>A scene will also have one or more <strong>light sources</strong>, and a <strong>camera</strong> to <em>serve</em> the scene in some perspective.</p>
<section id="meshes-objects-geometries-and-materials" class="level2">
<h2 class="anchored" data-anchor-id="meshes-objects-geometries-and-materials">Meshes, Objects, Geometries, and Materials</h2>
<p>An <code>object</code>, for the foreseeable future, means an object file of the <a href="https://en.wikipedia.org/wiki/Wavefront_.obj_file">OBJ Wavefront format</a>. These are files that consist of <code>object.children[n].geometry</code> and <code>object.children[n].material</code> fields. However, the material fields inside an OBJ are just <em>references</em> (via <code>usemtl</code> statements) to the true materials which come separately in <code>.mtl</code> files (typically from the same place as the <code>.obj</code> file).</p>
<p>There’s usually no need to break the object down into individual child geometries and their corresponding objects. But, it’s certainly possible. One use case would be if we want to apply a different transformation to each component. Usually, however, we load the object as a whole.</p>
</section>
</section>
<section id="our-first-canvas" class="level1">
<h1>Our First Canvas</h1>
<p>Let’s create a <code>&lt;canvas&gt;</code> with <code>id="three-d-canvas"</code>.</p>
<p>We can do it either using raw markup below this very cell, or by using the <code>IPython.display</code> module which allows us to display rich representations of objects in a Jupyter notebook (much like the <code>Deno.jupyter.display</code> module we saw in the <a href="../d3_in_jupyter_with_deno/d3_js_in_jupyter_with_deno.ipynb">D3.js US map post</a>).</p>
<p>Using <code>IPython.display</code> is more reliable.</p>
<div id="cell-2" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas"></canvas>
</div>
</div>
<p>Here’s the code that produces the above output. Feel free to expand and examine. We will paint the general strokes below.</p>
<details>
<summary>
Click to expand the Torus code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/+esm'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">setZ</span>(<span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canvas</span><span class="op">:</span> canvas</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>( <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> )<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>( bodyWidth<span class="op">,</span> bodyHeight )<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> geometry <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">TorusGeometry</span>(<span class="dv">10</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> material <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshBasicMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0xFF6347</span><span class="op">,</span> <span class="dt">wireframe</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> torus <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(geometry<span class="op">,</span> material)<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(torus)<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.005</span><span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="fu">animate</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>You’ll notice some general strokes.</p>
<section id="creating-a-scene" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-scene">Creating a Scene</h2>
<p>First, we create a <code>three.Scene</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="defining-scene-properties-and-selecting-a-canvas" class="level2">
<h2 class="anchored" data-anchor-id="defining-scene-properties-and-selecting-a-canvas">Defining Scene Properties and Selecting a Canvas</h2>
<p>Then, we define some constants for Three.js’s <a href="https://threejs.org/docs/#api/en/renderers/WebGLRenderer">WebGLRenderer</a> relative to the HTML document’s body (grabbing the latter using the DOM API).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We then grab the <code>&lt;canvas&gt;</code> element we created.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-a-camera" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-camera">Creating a Camera</h2>
<p>After defining scene properties, we create a <a href="https://threejs.org/docs/#api/en/cameras/PerspectiveCamera">PerspectiveCamera</a>, supplying it the <a href="https://en.wikipedia.org/wiki/Field_of_view">field of view</a> among other attributes, and setting its position.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">setZ</span>(<span class="dv">30</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-a-webgl-renderer" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-webgl-renderer">Creating a WebGL Renderer</h2>
<p>We then create the <code>WebGLRenderer</code> object, supplying it the <code>canvas</code> to render, as well as setting some of its parameters to the constants we defined in step one.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canvas</span><span class="op">:</span> canvas</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>( <span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span> )<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>( bodyWidth<span class="op">,</span> bodyHeight )<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rendering-the-scene-and-adding-objects" class="level2">
<h2 class="anchored" data-anchor-id="rendering-the-scene-and-adding-objects">Rendering the Scene and Adding Objects</h2>
<p>Finally, we render the scene by invoking the renderer’s <code>.render(scene, camera)</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>scene</code> object continues to be our window into the 3D world we just created. To it, we add <code>geometries</code> and their <code>materials</code> through a combination object called a <a href="https://threejs.org/docs/#api/en/objects/Mesh">Mesh</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> geometry <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">TorusGeometry</span>(<span class="dv">10</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> material <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">MeshBasicMaterial</span>({ <span class="dt">color</span><span class="op">:</span> <span class="bn">0xFF6347</span><span class="op">,</span> <span class="dt">wireframe</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> torus <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Mesh</span>(geometry<span class="op">,</span> material)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(torus)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adding-animations" class="level2">
<h2 class="anchored" data-anchor-id="adding-animations">Adding animations</h2>
<p>We can also add a little life to the scene by using a custom animation function.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">x</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.005</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    torus<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We invoke the animation within the outer lexical environment (for now).</p>
<pre><code>animate();</code></pre>
</section>
</section>
<section id="optional-grid-view-in-jupyter-notes" class="level1">
<h1>(Optional) Grid View in Jupyter Notes</h1>
<p>To display multiple 3D <code>scenes</code> in a grid, we can simply use a CSS-grid inside Jupyter.</p>
<p>First we lay out the markup inside the notes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-container"</span><span class="dt">&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-1"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-2"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-3"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"three-d-grid-item"</span><span class="dt">&gt;&lt;</span><span class="kw">canvas</span><span class="ot"> id</span><span class="op">=</span><span class="st">"three-d-canvas-4"</span><span class="dt">&gt;&lt;/</span><span class="kw">canvas</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, we include the stylesheet in this post’s subdirectory, and use Quarto’s front-matter to load it into the browser (just as we load the external scripts used to produce these rich 3D outputs):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">include-after-body</span><span class="kw">:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;script type="module" src="./javascript/three-js-demo.js"&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It turns out that there’s support for including CSS inside a Quarto post. It’s done using the <code>format.html</code> flag in the front-matter as follows:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">css</span><span class="kw">:</span><span class="at"> ./css/three-js-demo.css</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The file <code>three-js-demo.css</code> should contain these minimal styles:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#three-d-grid-container</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">grid-template-columns</span><span class="ch">:</span> <span class="fu">repeat(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="dt">fr</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">grid-template-rows</span><span class="ch">:</span> <span class="fu">repeat(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="dt">fr</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">gap</span><span class="ch">:</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">height</span><span class="ch">:</span> <span class="dv">50</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.three-d-grid-item</span> {</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s add the grid markup.</p>
<p>Now, inside the external script, we can reference the various <code>canvas</code> elements by <code>id</code>.</p>
<div id="cell-7" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>display(HTML(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div id='three-d-grid-container'&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-1"&gt;&lt;canvas id="three-d-canvas-1"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-2"&gt;&lt;canvas id="three-d-canvas-2"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-3"&gt;&lt;canvas id="three-d-canvas-3"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;div class="three-d-grid-item" id="three-d-grid-item-4"&gt;&lt;canvas id="three-d-canvas-4"&gt;&lt;/canvas&gt;&lt;/div&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

    <div id="three-d-grid-container">
        <div class="three-d-grid-item" id="three-d-grid-item-1"><canvas id="three-d-canvas-1"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-2"><canvas id="three-d-canvas-2"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-3"><canvas id="three-d-canvas-3"></canvas></div>
        <div class="three-d-grid-item" id="three-d-grid-item-4"><canvas id="three-d-canvas-4"></canvas></div>
    </div>
    
</div>
</div>
</section>
<section id="loading-custom-objects-with-materials" class="level1">
<h1>Loading Custom Objects with Materials</h1>
<p>Quarto won’t serve <code>.obj</code> files (at least by default), so we can just commit the object file to the remote repository and use the <code>raw</code> GitHub link (as a CDN).</p>
<p>We will also need the <code>OBJLoader</code>, a Three.js add-on. This can be grabbed from a CDN as well. We may also include it in the <code>include-after-body.text</code> front matter <em>before</em> loading the script file itself as:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;script type="importmap"&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">"imports"</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"three"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/+esm"</span><span class="kw">,</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"OBJLoader"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then, within the script, import as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'three'</span><span class="op">;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'OBJLoader'</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s the full code to render a rubber ducky which will help us in debugging our code going forward! I downloaded this model from <a href="https://sketchfab.com/3d-models/rubber-duck-ecb9ce9ff973406398ee56e391f9c902">Sketchfab</a> which hosts many such free models.</p>
<p>The code snippet also creates a sky background. This can be done in several ways, the most unsophisticated of which is to add a simple gradient background.</p>
<p>Going one step further, we can add a skybox (a <a href="https://threejs.org/docs/#api/en/loaders/CubeTextureLoader">cubemap</a>).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loader <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeTextureLoader</span>()<span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> skyboxTexture <span class="op">=</span> loader<span class="op">.</span><span class="fu">load</span>([</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'px.jpg'</span><span class="op">,</span> <span class="co">// Right</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'nx.jpg'</span><span class="op">,</span> <span class="co">// Left</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'py.jpg'</span><span class="op">,</span> <span class="co">// Top</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'ny.jpg'</span><span class="op">,</span> <span class="co">// Bottom</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">'pz.jpg'</span><span class="op">,</span> <span class="co">// Front</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">'nz.jpg'</span>  <span class="co">// Back</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Set the scene's background to `skyboxTexture`</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="at">background</span> <span class="op">=</span> skyboxTexture<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s a <a href="https://jaxry.github.io/panorama-to-cubemap/">convenient tool</a> that lets us convert a 360<span class="math inline">\(^{\circ}\)</span> image of a sky into a cubemap. We can also download existing cubemaps from the internet. One place to get them is <a href="https://polyhaven.com/a/lilienstein">Poly Haven’s HDRI section</a>. We can download any sky HDRs and use <a href="https://matheowis.github.io/HDRI-to-CubeMap/">this awesome tool</a> which converts the HDR file into six separate textures which can be supplied to the <code>loader.load()</code> call above.</p>
<p>Then, <a href="https://threejs.org/docs/#api/en/cameras/CubeCamera">CubeCamera</a> is used to render the skybox images. This camera exists independently of the main camera in our scene. The <code>CubeCamera</code> uses what’s known as a <a href="https://webglfundamentals.org/webgl/lessons/webgl-render-to-texture.html">render target</a> (a buffer where the GPU draws pixels for a scene that is being rendered in the background). Our <code>CubeCamera</code> will use <a href="https://threejs.org/docs/index.html#api/en/renderers/WebGLRenderTarget">WebGLCubeRenderTarget</a> to render the skybox images.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create the CubeRenderTarget and CubeCamera</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeRenderTarget <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLCubeRenderTarget</span>(<span class="dv">512</span>)<span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeCamera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeCamera</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> cubeRenderTarget)<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Add CubeCamera to the scene</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(cubeCamera)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also have the option to use the <code>Sky</code> class that’s built into Three.js to generate a procedural sky. The <code>Sky</code> class is a separate import accessible at the CDN address:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/objects/Sky.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, this is beyond the scope of this post.</p>
<p>Here’s the final code snippet that produces the scene below.</p>
<details>
<summary>
Click to expand the code used to generate the rubber ducky
</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/build/three.module.js'</span><span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { OBJLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js'</span><span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MTLLoader } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js'</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the container and set dimensions</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"quarto-document-content"</span>)<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyWidth <span class="op">=</span> body<span class="op">.</span><span class="at">clientWidth</span><span class="op">;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bodyHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Set up the canvas, scene, camera, and renderer</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> canvas <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"three-d-canvas"</span>)<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scene <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Scene</span>()<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> camera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">PerspectiveCamera</span>(<span class="dv">75</span><span class="op">,</span> bodyWidth <span class="op">/</span> bodyHeight<span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLRenderer</span>({ <span class="dt">canvas</span><span class="op">:</span> canvas })<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setPixelRatio</span>(<span class="bu">window</span><span class="op">.</span><span class="at">devicePixelRatio</span>)<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">setSize</span>(bodyWidth<span class="op">,</span> bodyHeight)<span class="op">;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Position the camera so the object will be in view.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Add some lights so the materials are visible.</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ambientLight <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">AmbientLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.6</span>)<span class="op">;</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(ambientLight)<span class="op">;</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> directionalLight <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">DirectionalLight</span>(<span class="bn">0xffffff</span><span class="op">,</span> <span class="fl">0.8</span>)<span class="op">;</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>directionalLight<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(directionalLight)<span class="op">;</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a skybox</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loader <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeTextureLoader</span>()<span class="op">;</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> px <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/px.png'</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nx <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nx.png'</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> py <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/py.png'</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ny <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/ny.png'</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pz <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/pz.png'</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nz <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/textures/skybox/nz.png'</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> texture <span class="op">=</span> loader<span class="op">.</span><span class="fu">load</span>([</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  px<span class="op">,</span> <span class="co">// Right</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  nx<span class="op">,</span> <span class="co">// Left</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  py<span class="op">,</span> <span class="co">// Top</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  ny<span class="op">,</span> <span class="co">// Bottom</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  pz<span class="op">,</span> <span class="co">// Front</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  nz  <span class="co">// Back</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Set the scene's background to `texture`</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="at">background</span> <span class="op">=</span> texture<span class="op">;</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Create the CubeRenderTarget</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeRenderTarget <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">WebGLCubeRenderTarget</span>(<span class="dv">512</span>)<span class="op">;</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cubeCamera <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">CubeCamera</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> cubeRenderTarget)<span class="op">;</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(cubeCamera)<span class="op">;</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="co">// Instantiate MTLLoader and define the URLs for the material and object.</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mtlLoader <span class="op">=</span> <span class="kw">new</span> <span class="fu">MTLLoader</span>()<span class="op">;</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckMtl <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.mtl"</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckObj <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/v-poghosyan/v-poghosyan.github.io/refs/heads/main/posts/visualization/three_js_in_jupyter/models/rubber_duck.obj"</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the MTL file first.</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>mtlLoader<span class="op">.</span><span class="fu">load</span>(</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  duckMtl<span class="op">,</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  (materials) <span class="kw">=&gt;</span> {</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    materials<span class="op">.</span><span class="fu">preload</span>()<span class="op">;</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Now load the OBJ file and set its materials.</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> objLoader <span class="op">=</span> <span class="kw">new</span> <span class="fu">OBJLoader</span>()<span class="op">;</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>    objLoader<span class="op">.</span><span class="fu">setMaterials</span>(materials)<span class="op">;</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>    objLoader<span class="op">.</span><span class="fu">load</span>(</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>      duckObj<span class="op">,</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>      (object) <span class="kw">=&gt;</span> {</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scale and position the loaded object.</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>        object<span class="op">.</span><span class="at">scale</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">5</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>        object<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>        scene<span class="op">.</span><span class="fu">add</span>(object)<span class="op">;</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Animation loop</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>          object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>          renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">animate</span>()<span class="op">;</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>      <span class="co">// onProgress callback</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>      (xhr) <span class="kw">=&gt;</span> {</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Loading object..."</span>)<span class="op">;</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>      <span class="co">// onError callback</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>      (error) <span class="kw">=&gt;</span> {</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'An error occurred while loading the OBJ:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">// onProgress callback for MTL</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>  (xhr) <span class="kw">=&gt;</span> {</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Loading materials..."</span>)<span class="op">;</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">// onError callback for MTL</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>  (error) <span class="kw">=&gt;</span> {</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'An error occurred while loading the MTL:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Note that <code>OBJLoader</code> takes the URL of the object followed by a callback function that gets triggered by the object fully loading.</p>
<p>The geometries of the object are in <code>object.children[n].geometry</code>. Each child is a part of the object (for example the eyes, wings, and nose of the duck correspond to the object’s child geometries).</p>
<p>Let’s create another canvas to render the rubber ducky.</p>
<div id="cell-9" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-5'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-5"></canvas>
</div>
</div>
<p>For the materials, we used <code>MTLLoader</code>. Another add-on downloaded from the following CDN in the <code>include-after-body.text</code> front matter:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;script type="importmap"&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">"imports"</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">"MTLLoader"</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">}</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">}</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice the nested calls? <code>OBJLoader</code> is typically called within <code>MTLLoader</code>, and gets the <code>material</code> supplied to it.</p>
<p>The <code>MTLLoader</code> loads the material file (<code>rubber_duck.mtl</code>) and then calls <code>materials.preload()</code>. The <code>OBJLoader</code>’s <code>.setMaterials(materials)</code> ensures that when the OBJ file is loaded, it uses the material definitions from the MTL file.</p>
</section>
<section id="adding-controls" class="level1">
<h1>Adding Controls</h1>
<p>What good is rendering a skybox if we can’t zoom and pan around to experience it in 3D? <a href="https://threejs.org/docs/#examples/en/controls/OrbitControls">OrbitControls</a> allow us to do just that! Let’s add them to our scene.</p>
<p><code>OrbitControls</code> can be imported from the following CDN:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As with all Three.js add-ons so far, we import <code>OrbitControls</code> using Quarto’s front-matter.</p>
<p>Once it’s imported, we add <code>OrbitControls</code> to our scene.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add OrbitControls</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controls <span class="op">=</span> <span class="kw">new</span> <span class="fu">OrbitControls</span>(camera<span class="op">,</span> renderer<span class="op">.</span><span class="at">domElement</span>)<span class="op">;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">enableDamping</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// Smooth damping effect during rotation</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>controls<span class="op">.</span><span class="at">dampingFactor</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line <code>const controls = new OrbitControls(camera, renderer.domElement)</code> passes <code>renderer.domElement</code> instead of just <code>renderer</code> because <code>OrbitControls</code> needs a DOM element to attach event listeners to (for mouse or touch interactions), not a renderer object. A Three.js rendering object manages the WebGL context, <code>renderer.domElement</code> is the actual HTML Canvas element to which Three.js renders the scene.</p>
<p>Furthermore, inside the <code>animate()</code> call, we need to ensure that we’re updating <code>CubeCamera</code>’s environment map. This is done to retain realistic reflections on shiny objects. Reflective objects show surrounding environment reflected on their surfaces, so the <code>CubeMap</code> needs to be updated whenever the scene changes in order to keep reflections on objects accurate.</p>
<p>The animate block, which previously looked like:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Becomes:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>() {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  object<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  cubeCamera<span class="op">.</span><span class="fu">update</span>(renderer<span class="op">,</span> scene)<span class="op">;</span>  </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  renderer<span class="op">.</span><span class="fu">render</span>(scene<span class="op">,</span> camera)<span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  controls<span class="op">.</span><span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The line <code>conrols.update()</code> is required the animation loop to ensure smooth interaction and rendering. Without this call, the camera might not respond to user input correctly.</p>
<p>Also, now that we have <code>OrbitControls</code>, let’s ensure we’re positioning the camera to show the duck at the start of our scene. This is done within the <code>OBJLoader</code> callback, where the <code>object</code> is defined.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">copy</span>(object<span class="op">.</span><span class="at">position</span>)<span class="op">;</span>  <span class="co">// Set camera at duck position</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="dv">20</span><span class="op">;</span>  <span class="co">// Add y-offset (adjust value as needed)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="at">z</span> <span class="op">+=</span> <span class="op">-</span><span class="dv">20</span>  <span class="co">// Add z-offset offset (adjust value as needed)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>camera5<span class="op">.</span><span class="fu">lookAt</span>(object<span class="op">.</span><span class="at">position</span>) <span class="co">// Orient the camera to look at the duck</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Go ahead and try the controls in the canvas above. Use:</p>
<ul>
<li>Right mouse button (RMB) to pan</li>
<li>Left mouse button (LMB) to rotate</li>
<li>Scroll wheel (SW) to zoom</li>
</ul>
<p>Before we move on to creating more complex scenes, with multiple objects, we should explore how an OBJ file represents an object. We will need to understand the structure of an Object to manipulate it correctly using Three.js.</p>
</section>
<section id="the-obj-representation-of-an-object" class="level1">
<h1>The OBJ Representation of an Object</h1>
<p>When Three.js gets an OBJ file, it represents it as this <code>Group</code>.</p>
<details>
<summary>
Click to expand pseudo-json with comments
</summary></details>
<div class="sourceCode" id="cb30"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="er">Group</span> <span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"children"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mesh"</span><span class="er">:</span> <span class="fu">{</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"geometry"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span> <span class="er">//</span> <span class="er">See</span> <span class="er">below</span> <span class="er">for</span> <span class="er">full</span> <span class="er">expansion...</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"material"</span><span class="er">:</span> <span class="st">"Material"</span> <span class="er">//</span> <span class="er">See</span> <span class="er">below</span> <span class="er">for</span> <span class="er">full</span> <span class="er">expansion...</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mesh"</span><span class="er">:</span> <span class="fu">{</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"geometry"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metadata"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Metadata</span> <span class="er">provides</span> <span class="er">info</span> <span class="er">about</span> <span class="er">the</span> <span class="er">export</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"version"</span><span class="fu">:</span> <span class="fl">4.5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Exporter</span> <span class="er">version</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Type</span> <span class="er">of</span> <span class="er">object</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"generator"</span><span class="fu">:</span> <span class="st">"BufferGeometry.toJSON"</span><span class="er">//</span> <span class="er">Method</span> <span class="er">that</span> <span class="er">generated</span> <span class="er">this</span> <span class="er">JSON</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"uuid"</span><span class="fu">:</span> <span class="st">"12345678-1234-1234-1234-123456789abc"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Unique</span> <span class="er">identifier</span> <span class="er">for</span> <span class="er">this</span> <span class="er">geometry</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"BufferGeometry"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Confirms</span> <span class="er">that</span> <span class="er">this</span> <span class="er">is</span> <span class="er">a</span> <span class="er">BufferGeometry</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Main</span> <span class="er">container</span> <span class="er">for</span> <span class="er">all</span> <span class="er">geometry</span> <span class="er">data</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"attributes"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Vertex</span> <span class="er">attributes</span> <span class="er">(data</span> <span class="er">arrays</span> <span class="er">for</span> <span class="er">each</span> <span class="er">vertex</span> <span class="er">property)</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"position"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Positions</span> <span class="er">of</span> <span class="er">vertices</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Each</span> <span class="er">vertex</span> <span class="er">position</span> <span class="er">has</span> <span class="er">3</span> <span class="er">components</span><span class="fu">:</span> <span class="er">x</span><span class="fu">,</span> <span class="er">y</span><span class="fu">,</span> <span class="er">z</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">stored</span> <span class="er">as</span> <span class="er">a</span> <span class="er">Float32Array</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">vertex</span> <span class="er">positions</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">is</span> <span class="er">not</span> <span class="er">normalized</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"normal"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Normals</span> <span class="er">at</span> <span class="er">each</span> <span class="er">vertex</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="er">//</span> <span class="er">3</span> <span class="er">components</span> <span class="er">per</span> <span class="er">normal</span> <span class="er">(x</span><span class="fu">,</span> <span class="er">y</span><span class="fu">,</span> <span class="er">z)</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">normals</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"uv"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Texture</span> <span class="er">coordinates</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Each</span> <span class="er">UV</span> <span class="er">coordinate</span> <span class="er">has</span> <span class="er">2</span> <span class="er">components</span><span class="fu">:</span> <span class="er">u</span><span class="fu">,</span> <span class="er">v</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Float32Array"</span><span class="fu">,</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Example</span> <span class="er">UV</span> <span class="er">values</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"normalized"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"index"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Index</span> <span class="er">data</span> <span class="er">defines</span> <span class="er">the</span> <span class="er">order</span> <span class="er">to</span> <span class="er">connect</span> <span class="er">vertices</span> <span class="er">into</span> <span class="er">triangles</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Uint16Array"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Data</span> <span class="er">type</span> <span class="er">of</span> <span class="er">the</span> <span class="er">index</span> <span class="er">array</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span> <span class="er">//</span> <span class="er">Indices</span> <span class="er">forming</span> <span class="er">triangles</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"groups"</span><span class="fu">:</span> <span class="ot">[</span> <span class="er">//</span> <span class="er">Groups</span> <span class="er">specify</span> <span class="er">portions</span> <span class="er">of</span> <span class="er">the</span> <span class="er">geometry</span> <span class="er">that</span> <span class="er">use</span> <span class="er">different</span> <span class="er">materials</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">{</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"start"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Starting</span> <span class="er">index</span> <span class="er">in</span> <span class="er">the</span> <span class="er">index</span> <span class="er">array</span> <span class="er">for</span> <span class="er">this</span> <span class="er">group</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"count"</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Number</span> <span class="er">of</span> <span class="er">indices</span> <span class="er">(here</span><span class="fu">,</span> <span class="er">one</span> <span class="er">quad</span> <span class="er">made</span> <span class="er">of</span> <span class="er">2</span> <span class="er">triangles)</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>              <span class="dt">"materialIndex"</span><span class="fu">:</span> <span class="dv">0</span>  <span class="er">//</span> <span class="er">Which</span> <span class="er">material</span> <span class="er">from</span> <span class="er">the</span> <span class="er">material</span> <span class="er">array</span> <span class="er">should</span> <span class="er">be</span> <span class="er">used</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>          <span class="ot">]</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"material"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metadata"</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">//</span> <span class="er">Metadata</span> <span class="er">about</span> <span class="er">this</span> <span class="er">material</span> <span class="er">export</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"version"</span><span class="fu">:</span> <span class="fl">4.5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Version</span> <span class="er">of</span> <span class="er">the</span> <span class="er">exporter</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Object"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">This</span> <span class="er">is</span> <span class="er">a</span> <span class="er">JSON</span> <span class="er">object</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>          <span class="dt">"generator"</span><span class="fu">:</span> <span class="st">"Material.toJSON"</span> <span class="er">//</span> <span class="er">Generated</span> <span class="er">by</span> <span class="er">Material.toJSON</span> <span class="er">method</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"uuid"</span><span class="fu">:</span> <span class="st">"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Unique</span> <span class="er">ID</span> <span class="er">for</span> <span class="er">the</span> <span class="er">material</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"MeshStandardMaterial"</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Type</span> <span class="er">of</span> <span class="er">material</span> <span class="er">(could</span> <span class="er">be</span> <span class="er">MeshBasicMaterial</span><span class="fu">,</span> <span class="er">etc.)</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"color"</span><span class="fu">:</span> <span class="dv">16777215</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Base</span> <span class="er">color</span> <span class="er">(in</span> <span class="er">decimal</span><span class="fu">,</span> <span class="er">here</span> <span class="er">16777215</span> <span class="er">equals</span> <span class="er">0xffffff</span> <span class="er">-</span> <span class="er">white)</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"roughness"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Roughness</span> <span class="er">parameter</span> <span class="er">(controls</span> <span class="er">how</span> <span class="er">rough</span> <span class="er">the</span> <span class="er">surface</span> <span class="er">is)</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"metalness"</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Metalness</span> <span class="er">parameter</span> <span class="er">(how</span> <span class="er">metallic</span> <span class="er">the</span> <span class="er">material</span> <span class="er">looks)</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"emissive"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Emissive</span> <span class="er">color</span> <span class="er">(self-illumination;</span> <span class="er">0</span> <span class="er">means</span> <span class="er">black</span><span class="fu">,</span> <span class="er">no</span> <span class="er">emission)</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"opacity"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Opacity</span> <span class="er">value</span> <span class="er">(1</span> <span class="er">means</span> <span class="er">fully</span> <span class="er">opaque)</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"transparent"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Flag</span> <span class="er">indicating</span> <span class="er">whether</span> <span class="er">the</span> <span class="er">material</span> <span class="er">supports</span> <span class="er">transparency</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"wireframe"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="er">//</span> <span class="er">If</span> <span class="er">true</span><span class="fu">,</span> <span class="er">the</span> <span class="er">material</span> <span class="er">renders</span> <span class="er">as</span> <span class="er">a</span> <span class="er">wireframe</span> <span class="er">instead</span> <span class="er">of</span> <span class="er">solid</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"side"</span><span class="fu">:</span> <span class="dv">2</span> <span class="er">//</span> <span class="er">Which</span> <span class="er">side</span> <span class="er">of</span> <span class="er">the</span> <span class="er">faces</span> <span class="er">to</span> <span class="er">render</span> <span class="er">(</span><span class="dv">2</span> <span class="er">indicates</span> <span class="er">DoubleSide)</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>  <span class="er">//</span> <span class="er">Other</span> <span class="er">group</span> <span class="er">properties...</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<p>In a <code>BufferGeometry</code>, the <em>index array</em>, which looks as below, is an optional array that defines how the vertices (stored in the attributes <code>"position"</code>) are connected to form faces (usually triangles). The indices (numbers) in an index array refer to vertices in the attributes.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="er">"index":</span> <span class="fu">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Uint16Array"</span><span class="fu">,</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For example, if our geometry’s <code>"position"</code> attribute contains the following vertices:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="er">"position":</span> <span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"itemSize"</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"array"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">0</span><span class="ot">]</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then the index array above tells Three.js to use the vertices at positions <code>0, 1, 2</code> to form the first triangle, and vertices at positions <code>0, 2, 3</code> to form the second triangle.</p>
<p>The <em>starting index</em> of the group refers to the <em>offset</em> in the index array where a specific group (which might be assigned a particular material) begins. The <code>"group"</code> defines a subset of the index array that should be rendered with a specific material.</p>
<p>Now that we understand the structure of an object better, we can build a mesh merger that preserves materials. This is required for rendering multiple ducks to the scene.</p>
</section>
<section id="creating-complex-scenes" class="level1">
<h1>Creating Complex Scenes</h1>
<p>HTML Canvas, by itself, is a thing of wonder. Here’s a curated list of cool <a href="https://github.com/raphamorim/awesome-canvas?tab=readme-ov-file">Canvas API examples</a>. For example, here’s <a href="https://cssdeck.com/labs/full/ping-pong-game-tutorial-with-html5-canvas-and-sounds">Pong</a>. Here’s a cool <a href="https://matrix.dotglitch.dev/">Matrix animation</a>, and here’s a tool that visualizes <a href="https://www.kevs3d.co.uk/dev/lsystems/#">L-systems</a>. The Canvas is what makes things like drawing tools or diagramming tools, such as <a href="https://www.lucidchart.comB">Lucidchart</a> or <a href="https://app.diagrams.net/">diagrams.net</a> (formerly Draw.io), possible on the browser.</p>
<p>For more complex scenes, the HTML Canvas with the Canvas API is not enough. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">Canvas API</a> is usually good for 2D applications – it explicitly sets its context as <code>"2d"</code>. This is where Three.js with its WebGL support comes in.</p>
<p>For truly complex 3D web-applications (complete with mouse and keyboard controls and other advanced features), we will need to integrate Three.js into a React app using <a href="https://r3f.docs.pmnd.rs/getting-started/introduction">React Three Fiber (r3f)</a>. React Three Fiber is a library that serves as a React renderer for Three.js. It enables the creation and management of 3D scenes and objects using React components, rather than plain HTML, which allows developers to leverage React’s ecosystem for state management, component reusability, effect management (through hooks like <code>useEffect</code>), and its DOM lifecycle methods, <code>componentDidMount</code>, <code>componentDidUpdate</code>, and <code>componentWillUnmount</code>, which abstract the browser’s own DOM events like <code>DOMContentLoaded</code>.</p>
<p>For now, however, we will not use React Three Fiber. We will see how far we can take Three.js in Jupyter notebooks using Quarto to publish on the browser. Let’s make a more complex scene by adding many more objects. Let’s add more rubber duckies to the scene. Once we are able to display more of the same object, we can add physics and make it rain rubber duckies!</p>
<section id="adding-multiple-of-the-same-object-to-a-scene" class="level2">
<h2 class="anchored" data-anchor-id="adding-multiple-of-the-same-object-to-a-scene">Adding Multiple of the Same Object to a Scene</h2>
<p>Previously we rendered separate scenes in a grid, now let’s see how many ducks we can add to the same scene.</p>
<p>Sure, we might think, let’s just use <code>object.clone()</code> in the <code>OBJLoader</code> callback:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Clone the already loaded duck object</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckClone <span class="op">=</span> object<span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But here’s where we first stumble onto major performance issues in the browser. Depending on how much memory our machine has, we will start noticing jittery behavior and slowed animations when we try to render <code>50</code> or more of these rubber ducky objects. Luckily, Three.js has an optimization for rendering multiple of the <em>same</em> object to the scene (even if they’re animated differently).</p>
<section id="instanced-mesh" class="level3">
<h3 class="anchored" data-anchor-id="instanced-mesh">Instanced Mesh</h3>
<p>This optimization is called <strong>instancing</strong>. In Three.js, instancing is implemented via the <code>InstancedMesh</code> class, which is what we have to use instead of <code>Mesh</code>. <code>InstancedMesh</code> lets us render many copies of the same geometry (and its corresponding material) using a <em>single</em> draw call to the GPU. Instead of creating a separate <code>Mesh</code> for each object, which incurs a draw call per object, we can create one <code>InstancedMesh</code> and assign each instance its own transformation matrix (and even per-instance colors if needed). This technique reduces CPU-to-GPU communication overhead, making it ideal for rendering thousands of identical objects efficiently.</p>
<p>We don’t call <code>clone()</code> for each duck when using instancing. Instead, we create one <code>InstancedMesh</code> that shares the <em>same</em> geometry and material for every instance and then assign each instance its own transformation matrix. A transformation matrix is just what it sounds like, it’s a matrix supplied to <code>InstancedMesh</code> that applies a <strong>rotation</strong>, a <strong>translation</strong>, and a <strong>scaling</strong> transform. This matrix sounds like it’s too complicated to come up with by ourselves, after all is this some kind of Linear Algebra exercise? We shall see that its, in fact, very simple and that there are a lot of tricks to help us do just that!</p>
<p><code>InstancedMesh</code> is basically an indexed data structure (like an array) that stores <em>instances</em> of the mesh. These instances aren’t directly accessible, unlike clones. However, we get the next best thing: an interface to update the transformation matrices of the instances (or to apply other instance attributes, like color). This interface consists of a getter method <code>getMatrixAt(index, matrix)</code>, and a setter method <code>setMatrixAt(index, matrix)</code>.</p>
<p>One question that may arise: Why does the getter method require a <code>matrix</code> parameter? The design of the <code>getMatrixAt</code> method is such that we supply an existing <code>Matrix4</code> as an empty container. The method, then, writes the transformation matrix of the instance at index <code>i</code> into the provided matrix.</p>
<p>But why do we use a <span class="math inline">\(4 \times 4\)</span> matrix in 3D space? For the answer to that, refer to the subsection below on <a href="#homogeneous-coordinates---linearaffine-transformations">homogeneous-coordinates</a>. For now, let’s accept that the <span class="math inline">\(4 \times 4\)</span> matrix does, indeed, describe a transformation in 3D space. One tip, when dealing with <code>InstancedMech</code>, is to avoid re-creating a new <code>Matrix4</code> object on every call and, instead, re-use one dummy transformation matrix.</p>
<p>Here’s the code, feel free to expand and examine. We will also walk through the changes at the bottom.</p>
<details>
<summary>
Click to expand
</summary>
<div class="sourceCode" id="cb34"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// NEW CODE WILL GO HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><code>InstancedMesh</code> works with a single <code>geometry</code> and <code>material</code>. Since our OBJ is a group, we need to extract the mesh out of it in order to instantiate the mesh.</p>
<p>The simplest way to do this is by taking the first mesh child <code>object.children[0]</code>.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the mesh from OBJ</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> duckMesh <span class="op">=</span> object<span class="op">.</span><span class="at">children</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>duckMesh) {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Loaded object does not contain a mesh.'</span>)<span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But this produces nothing other than the duck’s wingless body without eyes or a beak. So we have to merge the geometries. This is done using the Three.js add-on <a href="https://threejs.org/docs/#examples/en/utils/BufferGeometryUtils.mergeBufferGeometries">BufferGeometryUtils.mergeBufferGeometries</a>. Armed with our understanding of the OBJ representation, let’s tackle this problem!</p>
<section id="merging-meshes-while-preserving-materials" class="level4">
<h4 class="anchored" data-anchor-id="merging-meshes-while-preserving-materials">Merging Meshes while Preserving Materials</h4>
<p>We need to merge the child meshes while preserving each of their materials. Somehow, we have got to preserve information about which <em>parts</em> of the merged geometry should use which material. In Three.js this is done using <code>groups</code> inside a <code>BufferGeometry</code>. Each <code>group</code> defines a <em>start index</em>, a <em>count</em>, and a <em>material index</em>. When using <code>mergeBufferGeometries</code>, we pass a second parameter as <code>true</code> to tell the function to preserve the groups from each individual geometry. Then we supply a materials array (in the same order that the groups refer to) when we create the Mesh.</p>
<p>Since merging meshes (while preserving the materials) is a thing we’re going to do quite often, let’s make a helper function called <code>mergeMeshes</code> that takes an array of <code>three.Mesh</code> objects, merges their geometries while preserving their material assignments via groups, and returns a single merged mesh. We’ll store it as its own module and import it into our external scripts. Here’s the implementation, see below it for an explanation of each step.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> three <span class="im">from</span> <span class="st">'three'</span><span class="op">;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { mergeBufferGeometries } <span class="im">from</span> <span class="st">'https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/utils/BufferGeometryUtils.js'</span><span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * mergeMeshes accepts an array of three.Mesh objects and returns a single merged mesh.</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * It preserves each mesh's material by assigning groups to the merged geometry.</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{three.Mesh</span><span class="co">[]} meshes - Array of meshes to merge.</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {three.Mesh} - A new mesh that is the merged result.</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mergeMeshes</span>(meshes) {</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Arrays to hold the individual geometries and their corresponding materials.</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> geometries <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> materials <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// materialIndex will be used to assign a unique material index for each mesh.</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> materialIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Loop through each mesh in the input array.</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  meshes<span class="op">.</span><span class="fu">forEach</span>((mesh) <span class="kw">=&gt;</span> {</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Update the world matrix so that we capture the mesh's global transformation.</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    mesh<span class="op">.</span><span class="fu">updateWorldMatrix</span>(<span class="kw">true</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Clone the mesh's geometry so we don't modify the original.</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> geom <span class="op">=</span> mesh<span class="op">.</span><span class="at">geometry</span><span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. Apply the mesh's world transformation to the geometry. This "bakes" the mesh's position, rotation, and scale into its vertices.</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    geom<span class="op">.</span><span class="fu">applyMatrix4</span>(mesh<span class="op">.</span><span class="at">matrixWorld</span>)<span class="op">;</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. If the geometry doesn't already have groups defined (which tell us which part uses which material),</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">//    we add a single group that covers the whole geometry.</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">//    This group assigns a material index that corresponds to the mesh's material in our materials array.</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (geom<span class="op">.</span><span class="at">groups</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Determine the number of elements (either from the index count or the vertex count)</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> count <span class="op">=</span> geom<span class="op">.</span><span class="at">index</span> <span class="op">?</span> geom<span class="op">.</span><span class="at">index</span><span class="op">.</span><span class="at">count</span> <span class="op">:</span> geom<span class="op">.</span><span class="at">attributes</span><span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="at">count</span><span class="op">;</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Add a group from start=0 to count with the current material index.</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>      geom<span class="op">.</span><span class="fu">addGroup</span>(<span class="dv">0</span><span class="op">,</span> count<span class="op">,</span> materialIndex)<span class="op">;</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 5. Push the processed geometry and the mesh's material into our arrays.</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    geometries<span class="op">.</span><span class="fu">push</span>(geom)<span class="op">;</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    materials<span class="op">.</span><span class="fu">push</span>(mesh<span class="op">.</span><span class="at">material</span>)<span class="op">;</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    materialIndex<span class="op">++;</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 6. Merge all the geometries into a single BufferGeometry.</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    The second argument 'true' tells the function to preserve the groups from each geometry.</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mergedGeometry <span class="op">=</span> <span class="fu">mergeBufferGeometries</span>(geometries<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 7. Create a new Mesh using the merged geometry and the array of materials.</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    THREE.Mesh accepts an array of materials when the geometry contains groups with material indices.</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mergedMesh <span class="op">=</span> <span class="kw">new</span> THREE<span class="op">.</span><span class="fu">Mesh</span>(mergedGeometry<span class="op">,</span> materials)<span class="op">;</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return the merged mesh.</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mergedMesh<span class="op">;</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First, inside the loop that iterates over each child mesh, we update the mesh’s <code>matrixWorld</code>. Calling <code>mesh.updateWorldMatrix(true, false)</code> ensures that the mesh’s <strong>global transformation</strong> (its position, rotation, and scale) is up-to-date. In short, updating the world matrix is necessary so that the transformation we apply to the geometry truly represents the mesh’s position, rotation, and scale within the entire scene. Each mesh as its own <strong>local transformation</strong> (which is exclusively applied to it), but meshes can also be in a group with its own local transformation. The final transformation, the <code>matrixWorld</code>, is the application of all these local transformation matrices. Calling <code>mesh.updateWorldMatrix(true, false)</code> just ensures this calculation is up-to-date.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mesh<span class="op">.</span><span class="fu">updateWorldMatrix</span>(<span class="kw">true</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It’s good practice to clone the mesh’s geometry so that we don’t alter the original.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> geom <span class="op">=</span> mesh<span class="op">.</span><span class="at">geometry</span><span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that earlier we cloned the entire object with <a href="https://threejs.org/docs/#api/en/core/Object3D.clone">three.Object3D.clone</a>, but now we’re cloning just the geometry of the mesh using <a href="https://threejs.org/docs/#api/en/core/BufferGeometry.clone">three.BufferGeometry.clone</a>.</p>
<p>Next step is to apply the updated world matrix (transformation) by calling <code>geom.applyMatrix4(mesh.matrixWorld)</code>. This is known as <em>baking-in</em> the mesh’s world transformation into the geometry. Don’t get discouraged if you don’t understand transformations, all that these transformations mean, essentially, is that the vertices of the geometry are moved to their correct positions in the world space.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>geom<span class="op">.</span><span class="fu">applyMatrix4</span>(mesh<span class="op">.</span><span class="at">matrixWorld</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We then assign groups (if absent). Groups in <code>BufferGeometry</code> indicate which sections of the geometry use which material. If a mesh’s geometry doesn’t already have groups, we add one covering the entire geometry and assign it the current <em>material index</em>. This is essential for preserving different materials when the geometries are merged.</p>
<ol type="1">
<li><p><strong>Collect Geometries and Materials:</strong><br>
We store each processed geometry and its corresponding material in separate arrays. The order is important because the group’s material index in each geometry will correspond to the position of the material in the <code>materials</code> array.</p></li>
<li><p><strong>Merge Geometries:</strong><br>
<code>mergeBufferGeometries(geometries, true)</code> merges all collected geometries into a single geometry, preserving the groups. This is what reduces the number of draw calls during rendering.</p></li>
<li><p><strong>Create Merged Mesh:</strong><br>
Finally, we create a new THREE.Mesh with the merged geometry and the array of materials. The merged geometry’s groups ensure that the correct material is used for each part of the merged mesh.</p></li>
</ol>
<p>You can now call this function with any array of meshes (for example, the children of a loaded OBJ) to obtain a single, optimized mesh with preserved materials.</p>
<p>—– I AM HERE (2) —–</p>
<p>Once we have the mesh extracted out of the OBJ, we create an <code>InstancedMesh</code> with <code>numDuckies</code> number of ducks, and supplying the mesh <code>geometry</code> and <code>material</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> numDuckies <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create an InstancedMesh using the duck's geometry and material.</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> instancedDuck <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">InstancedMesh</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  duckMesh<span class="op">.</span><span class="at">geometry</span><span class="op">,</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  duckMesh<span class="op">.</span><span class="at">material</span><span class="op">,</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  numDuckies</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As we would do with regular objects (like clones), we need to add the <code>InstancedMesh</code> to the scene using:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(instancedDuck)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The next step involves an industry trick. Instead of coming up with a transformation matrix ourselves, we create a <code>dummy</code> object and use its <code>.position.set(x,y,z)</code> as always. We give it some rotation (like before). Then we do <code>.updateMatrix()</code> and use its <code>.matrix</code> to <em>get</em> the object’s transformation matrix.</p>
<p>Once we have this <code>dummy</code> object’s transformation matrix, we provide it to the <code>.setMatrixAt(index, matrix)</code> method of the <code>InstancedMesh</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a dummy Object3D to build transformation matrices.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dummy <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">Object3D</span>()<span class="op">;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize each instance with a random position and rotation.</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numDuckies<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="at">position</span><span class="op">.</span><span class="fu">set</span>(</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">randInRange</span>(<span class="op">-</span><span class="dv">30</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">,</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">randInRange</span>(<span class="op">-</span><span class="dv">30</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">,</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">randInRange</span>(<span class="op">-</span><span class="dv">30</span><span class="op">,</span> <span class="dv">30</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="fu">randInRange</span>(<span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  instancedDuck<span class="op">.</span><span class="fu">setMatrixAt</span>(i<span class="op">,</span> dummy<span class="op">.</span><span class="at">matrix</span>)<span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, we need to update the <code>animate()</code> function to apply a <span class="math inline">\(y\)</span>-rotation to each individual instance. This is where <code>matrix.decompose(position, rotation, scale)</code> comes in. It does what it sounds like it does! It decomposes a <span class="math inline">\(4 \times 4\)</span> transformation matrix into its constituent transformations: capturing the translation, rotation, and scale.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Animate: update rotation for each instance.</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">animate</span>(time) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requestAnimationFrame</span>(animate)<span class="op">;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Rotate each duck around its own y-axis.</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numDuckies<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Retrieve the current matrix of instance i.</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    instancedDuck<span class="op">.</span><span class="fu">getMatrixAt</span>(i<span class="op">,</span> dummy<span class="op">.</span><span class="at">matrix</span>)<span class="op">;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Decompose the matrix into position, rotation, and scale.</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    dummy<span class="op">.</span><span class="at">matrix</span><span class="op">.</span><span class="fu">decompose</span>(dummy<span class="op">.</span><span class="at">position</span><span class="op">,</span> dummy<span class="op">.</span><span class="at">rotation</span><span class="op">,</span> dummy<span class="op">.</span><span class="at">scale</span>)<span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Increment the rotation.</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    dummy<span class="op">.</span><span class="at">rotation</span><span class="op">.</span><span class="at">y</span> <span class="op">+=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update the dummy's matrix.</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    dummy<span class="op">.</span><span class="fu">updateMatrix</span>()<span class="op">;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the new matrix for instance i.</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    instancedDuck<span class="op">.</span><span class="fu">setMatrixAt</span>(i<span class="op">,</span> dummy<span class="op">.</span><span class="at">matrix</span>)<span class="op">;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mark the instance matrix attribute as needing an update.</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  instancedDuck<span class="op">.</span><span class="at">instanceMatrix</span><span class="op">.</span><span class="at">needsUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  renderer6<span class="op">.</span><span class="fu">render</span>(scene6<span class="op">,</span> camera6)<span class="op">;</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
</section>
<section id="homogeneous-coordinates---linearaffine-transformations" class="level1">
<h1>Homogeneous Coordinates - Linear/Affine Transformations</h1>
<p>Why do 3D graphics use a <span class="math inline">\(4 \times 4\)</span> matrix (<code>Matrix4</code>) rather than a <span class="math inline">\(3 \times 3\)</span> matrix to represent transformations in 3D space? A <span class="math inline">\(3 \times 3\)</span> matrix can handle linear transformations like rotation and scaling, but it cannot handle affine transformations like a simple translation. It also can’t handle projection (<strong>perspective</strong> or <strong>orthogonal</strong> – corresponding to non-linear and linear transformations).</p>
<p>The <span class="math inline">\(4 \times 4\)</span> matrix incorporates an extra row and column that stores the translation (or projection) components, enabling <em>all</em> simple transformations to be combined into one matrix. This makes it very efficient for computer graphics since we can apply a single matrix to transform an object in 3D space, reducing the number of required matrix operations.</p>
<p>The use of a <span class="math inline">\(4 \times 4\)</span> matrix necessitates the use of <strong>homogeneous coordinates</strong> (which all 3D libraries do under the hood). This is when the normal <span class="math inline">\((x,y,x)\)</span> coordinates are augmented as <span class="math inline">\((x,y,z,w)\)</span> (where <span class="math inline">\(w\)</span> is an extra coordinate that’s <span class="math inline">\(1\)</span> by default). Let’s see how this helps. Suppose we want to translate a point by <span class="math inline">\((t_x, t_y, t_z)\)</span>. In homogeneous coordinates, the translation matrix is:</p>
<p><span class="math display">\[
T = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; t_x \\
0 &amp; 1 &amp; 0 &amp; t_y \\
0 &amp; 0 &amp; 1 &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\]</span></p>
<p>Now, take a point <span class="math inline">\(P\)</span> represented as:</p>
<p><span class="math display">\[
P = \begin{pmatrix} x \\ y \\ z \\ 1 \end{pmatrix}
\]</span></p>
<p>When we apply the translation matrix (identity transformation) to the point, we multiply:</p>
<p><span class="math display">\[
T P = \begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; t_x \\
0 &amp; 1 &amp; 0 &amp; t_y \\
0 &amp; 0 &amp; 1 &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
\begin{pmatrix} x \\ y \\ z \\ 1 \end{pmatrix}
=
\begin{pmatrix}
x + t_x \\
y + t_y \\
z + t_z \\
1
\end{pmatrix}
\]</span></p>
<p>This shows that the point <span class="math inline">\((x, y, z)\)</span> is translated to <span class="math inline">\((x+t_x, y+t_y, z+t_z)\)</span>. We simply mentally discard the extra coordinate.</p>
<p>In summary, the extra coordinate <span class="math inline">\(w\)</span> in homogeneous coordinates enables us to include translation (and projection) in the <em>same</em> framework as other transformations.</p>
</section>
<section id="the-coordinate-system-in-three.js" class="level1">
<h1>The Coordinate System in Three.js</h1>
<p>This is a good time to make an effort to understand the coordinate system in Three.js. How do we know which specific range of positions to supply <code>randInRange</code>? We can actually display the axes and coordinate grid. Click the note below to see how.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="💡 Tip: Displaying `AxesHelper` and `GridHelper` in the Scene">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Tip: Displaying <code>AxesHelper</code> and <code>GridHelper</code> in the Scene
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>AxesHelper</code> displays lines for the x, y, and z axes (typically colored red, green, and blue, respectively). For example:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// An AxesHelper with a size of 50 units</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> axesHelper <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">AxesHelper</span>(<span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(axesHelper)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This helper will render lines originating from the scene’s origin <span class="math inline">\((0, 0, 0)\)</span>, so we can visually see how objects are positioned relative to it.</p>
<p>If we want an additional visual cue that represents a grid on the ground (helpful for orienting objects in a scene), we can use the <code>GridHelper</code>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A GridHelper with a grid size of 100 and 10 divisions</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> gridHelper <span class="op">=</span> <span class="kw">new</span> three<span class="op">.</span><span class="fu">GridHelper</span>(<span class="dv">100</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="fu">add</span>(gridHelper)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, if our grid or axes are not showing up it may be due to the camera’s position. We can point the camera to any vector!</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>camera<span class="op">.</span><span class="fu">lookAt</span>(<span class="kw">new</span> three<span class="op">.</span><span class="fu">Vector3</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Let’s create another canvas for our new scene!</p>
<div id="cell-12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">"&lt;canvas id='three-d-canvas-6'&gt;&lt;/canvas&gt;"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<canvas id="three-d-canvas-6"></canvas>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/v-poghosyan\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2021, Vahram Poghosyan</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/v-poghosyan">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/vahrampoghosyan/">
      <i class="bi bi-linkedin" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script type="application/javascript" src="../../../javascript/light-dark.js"></script>
<script type="importmap">
  {
      "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.173.0/+esm",
          "OBJLoader": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/OBJLoader.js",
          "MTLLoader": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/loaders/MTLLoader.js",
          "OrbitControls": "https://cdn.skypack.dev/three@0.133.0/examples/jsm/controls/OrbitControls.js"
      }
  }
</script>
<script type="module" src="./javascript/three-js-demo.js"></script>
<script type="module" src="./javascript/three-js-grid-demo.js"></script>
<script type="module" src="./javascript/three-js-duck-demo.js"></script>
<script type="module" src="./javascript/three-js-many-ducks-demo.js"></script>




</body></html>